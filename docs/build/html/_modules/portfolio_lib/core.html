

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>portfolio_lib.core &mdash; portfolio-lib v1.0.1 Documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../_static/plot_directive.css" />
      <link rel="stylesheet" type="text/css" href="../../_static/custom.css?v=97502c36" />

  
    <link rel="canonical" href="https://your-username.github.io/Portfolio-lib/_modules/portfolio_lib/core.html" />
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=c4955cf7"></script>
      <script src="../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: #2980B9" >

          
          
          <a href="../../index.html" class="icon icon-home">
            portfolio-lib
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Getting Started:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../getting_started.html">Getting Started</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">User Guide:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../examples.html">portfolio_lib Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../advanced_usage.html">Advanced Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../visual_guide.html">Visual Guide</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Reference:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../api_reference.html">API Reference</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Help &amp; Support:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../troubleshooting.html">Troubleshooting Guide</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: #2980B9" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">portfolio-lib</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">portfolio_lib.core</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for portfolio_lib.core</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Portfolio-lib - Lightweight Python Backtesting Library</span>
<span class="sd">A comprehensive backtesting framework for algorithmic trading strategies</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">yfinance</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">yf</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Union</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="Position">
<a class="viewcode-back" href="../../portfolio_lib.core.html#portfolio_lib.core.Position">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Position</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Represents a trading position&quot;&quot;&quot;</span>
<div class="viewcode-block" id="Position.__init__">
<a class="viewcode-back" href="../../portfolio_lib.core.html#portfolio_lib.core.Position.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">quantity</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">entry_price</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">:</span> <span class="n">datetime</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">symbol</span> <span class="o">=</span> <span class="n">symbol</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">quantity</span> <span class="o">=</span> <span class="n">quantity</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shares</span> <span class="o">=</span> <span class="n">quantity</span>  <span class="c1"># Alias for compatibility</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">entry_price</span> <span class="o">=</span> <span class="n">entry_price</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">price</span> <span class="o">=</span> <span class="n">entry_price</span>  <span class="c1"># Alias for compatibility</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timestamp</span> <span class="o">=</span> <span class="n">timestamp</span> <span class="ow">or</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_price</span> <span class="o">=</span> <span class="n">entry_price</span></div>

        
    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">market_value</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">quantity</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_price</span>
        
    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">unrealized_pnl</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_price</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">entry_price</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">quantity</span>
        
    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">unrealized_pnl_pct</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">entry_price</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">0.0</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_price</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">entry_price</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">entry_price</span> <span class="o">*</span> <span class="mi">100</span>
        
    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">value</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Alias for market_value for compatibility&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">market_value</span></div>


<div class="viewcode-block" id="Trade">
<a class="viewcode-back" href="../../portfolio_lib.core.html#portfolio_lib.core.Trade">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Trade</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Represents a completed trade&quot;&quot;&quot;</span>
<div class="viewcode-block" id="Trade.__init__">
<a class="viewcode-back" href="../../portfolio_lib.core.html#portfolio_lib.core.Trade.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">quantity</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">price</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">:</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">action</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">side</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">commission</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">symbol</span> <span class="o">=</span> <span class="n">symbol</span>
        <span class="c1"># Support both action (BUY/SELL) and side (buy/sell) parameters</span>
        <span class="k">if</span> <span class="n">action</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">action</span> <span class="o">=</span> <span class="n">action</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">side</span> <span class="o">=</span> <span class="n">action</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">side</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">side</span> <span class="o">=</span> <span class="n">side</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">action</span> <span class="o">=</span> <span class="n">side</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">side</span> <span class="o">=</span> <span class="s1">&#39;buy&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">action</span> <span class="o">=</span> <span class="s1">&#39;BUY&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">quantity</span> <span class="o">=</span> <span class="n">quantity</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shares</span> <span class="o">=</span> <span class="n">quantity</span>  <span class="c1"># Alias for compatibility</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">price</span> <span class="o">=</span> <span class="n">price</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timestamp</span> <span class="o">=</span> <span class="n">timestamp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">commission</span> <span class="o">=</span> <span class="n">commission</span></div>

        
    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">gross_value</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">quantity</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">price</span>
        
    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">net_value</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">gross_value</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">commission</span></div>


<div class="viewcode-block" id="Portfolio">
<a class="viewcode-back" href="../../portfolio_lib.core.html#portfolio_lib.core.Portfolio">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Portfolio</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Portfolio management class&quot;&quot;&quot;</span>
<div class="viewcode-block" id="Portfolio.__init__">
<a class="viewcode-back" href="../../portfolio_lib.core.html#portfolio_lib.core.Portfolio.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">initial_cash</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">100000.0</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initial_cash</span> <span class="o">=</span> <span class="n">initial_cash</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cash</span> <span class="o">=</span> <span class="n">initial_cash</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Position</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trades</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Trade</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">equity_curve</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timestamps</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">datetime</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span></div>

        
<div class="viewcode-block" id="Portfolio.add_trade">
<a class="viewcode-back" href="../../portfolio_lib.core.html#portfolio_lib.core.Portfolio.add_trade">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">add_trade</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trade</span><span class="p">:</span> <span class="n">Trade</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add a trade to the portfolio&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trades</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">trade</span><span class="p">)</span>
        
        <span class="c1"># Check if it&#39;s a buy trade (handle both side and action attributes)</span>
        <span class="n">is_buy</span> <span class="o">=</span> <span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">trade</span><span class="p">,</span> <span class="s1">&#39;side&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">trade</span><span class="o">.</span><span class="n">side</span> <span class="o">==</span> <span class="s1">&#39;buy&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">trade</span><span class="p">,</span> <span class="s1">&#39;action&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">trade</span><span class="o">.</span><span class="n">action</span> <span class="o">==</span> <span class="s1">&#39;BUY&#39;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">is_buy</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cash</span> <span class="o">-=</span> <span class="n">trade</span><span class="o">.</span><span class="n">net_value</span>
            <span class="k">if</span> <span class="n">trade</span><span class="o">.</span><span class="n">symbol</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">:</span>
                <span class="c1"># Average cost basis for additional shares</span>
                <span class="n">existing</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">trade</span><span class="o">.</span><span class="n">symbol</span><span class="p">]</span>
                <span class="n">total_quantity</span> <span class="o">=</span> <span class="n">existing</span><span class="o">.</span><span class="n">quantity</span> <span class="o">+</span> <span class="n">trade</span><span class="o">.</span><span class="n">quantity</span>
                <span class="n">avg_price</span> <span class="o">=</span> <span class="p">((</span><span class="n">existing</span><span class="o">.</span><span class="n">quantity</span> <span class="o">*</span> <span class="n">existing</span><span class="o">.</span><span class="n">entry_price</span><span class="p">)</span> <span class="o">+</span> 
                           <span class="p">(</span><span class="n">trade</span><span class="o">.</span><span class="n">quantity</span> <span class="o">*</span> <span class="n">trade</span><span class="o">.</span><span class="n">price</span><span class="p">))</span> <span class="o">/</span> <span class="n">total_quantity</span>
                <span class="n">existing</span><span class="o">.</span><span class="n">quantity</span> <span class="o">=</span> <span class="n">total_quantity</span>
                <span class="n">existing</span><span class="o">.</span><span class="n">entry_price</span> <span class="o">=</span> <span class="n">avg_price</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">trade</span><span class="o">.</span><span class="n">symbol</span><span class="p">]</span> <span class="o">=</span> <span class="n">Position</span><span class="p">(</span>
                    <span class="n">trade</span><span class="o">.</span><span class="n">symbol</span><span class="p">,</span> <span class="n">trade</span><span class="o">.</span><span class="n">quantity</span><span class="p">,</span> <span class="n">trade</span><span class="o">.</span><span class="n">price</span><span class="p">,</span> <span class="n">trade</span><span class="o">.</span><span class="n">timestamp</span>
                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># sell</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cash</span> <span class="o">+=</span> <span class="n">trade</span><span class="o">.</span><span class="n">net_value</span>
            <span class="k">if</span> <span class="n">trade</span><span class="o">.</span><span class="n">symbol</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">:</span>
                <span class="n">position</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">trade</span><span class="o">.</span><span class="n">symbol</span><span class="p">]</span>
                <span class="n">position</span><span class="o">.</span><span class="n">quantity</span> <span class="o">-=</span> <span class="n">trade</span><span class="o">.</span><span class="n">quantity</span>
                <span class="k">if</span> <span class="n">position</span><span class="o">.</span><span class="n">quantity</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">trade</span><span class="o">.</span><span class="n">symbol</span><span class="p">]</span></div>

    
<div class="viewcode-block" id="Portfolio.update_prices">
<a class="viewcode-back" href="../../portfolio_lib.core.html#portfolio_lib.core.Portfolio.update_prices">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">update_prices</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prices</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span> <span class="n">timestamp</span><span class="p">:</span> <span class="n">datetime</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Update current prices for all positions&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">position</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="n">prices</span><span class="p">:</span>
                <span class="n">position</span><span class="o">.</span><span class="n">current_price</span> <span class="o">=</span> <span class="n">prices</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span>
        
        <span class="c1"># Record equity curve</span>
        <span class="n">total_equity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_equity</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">equity_curve</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">total_equity</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timestamps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">timestamp</span><span class="p">)</span></div>

    
    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">total_equity</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate total portfolio equity&quot;&quot;&quot;</span>
        <span class="n">positions_value</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">pos</span><span class="o">.</span><span class="n">market_value</span> <span class="k">for</span> <span class="n">pos</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cash</span> <span class="o">+</span> <span class="n">positions_value</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">total_return</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate total return percentage&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_cash</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">0.0</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">total_equity</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_cash</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_cash</span> <span class="o">*</span> <span class="mi">100</span>
        
    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">total_value</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Alias for total_equity for compatibility&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_equity</span></div>


<div class="viewcode-block" id="DataFeed">
<a class="viewcode-back" href="../../portfolio_lib.html#portfolio_lib.core.DataFeed">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">DataFeed</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Base class for data feeds&quot;&quot;&quot;</span>
<div class="viewcode-block" id="DataFeed.__init__">
<a class="viewcode-back" href="../../portfolio_lib.html#portfolio_lib.core.DataFeed.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbols</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">symbols</span> <span class="o">=</span> <span class="n">symbols</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span></div>

    
<div class="viewcode-block" id="DataFeed.load_data">
<a class="viewcode-back" href="../../portfolio_lib.html#portfolio_lib.core.DataFeed.load_data">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">load_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start_date</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">end_date</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Load data for the specified date range&quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>
</div>


<div class="viewcode-block" id="YFinanceDataFeed">
<a class="viewcode-back" href="../../portfolio_lib.core.html#portfolio_lib.core.YFinanceDataFeed">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">YFinanceDataFeed</span><span class="p">(</span><span class="n">DataFeed</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Yahoo Finance data feed&quot;&quot;&quot;</span>
<div class="viewcode-block" id="YFinanceDataFeed.load_data">
<a class="viewcode-back" href="../../portfolio_lib.core.html#portfolio_lib.core.YFinanceDataFeed.load_data">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">load_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start_date</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">end_date</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Load data from Yahoo Finance&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbols</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">ticker</span> <span class="o">=</span> <span class="n">yf</span><span class="o">.</span><span class="n">Ticker</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">ticker</span><span class="o">.</span><span class="n">history</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="n">start_date</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">end_date</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: No data found for </span><span class="si">{</span><span class="n">symbol</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error loading data for </span><span class="si">{</span><span class="n">symbol</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="YFinanceDataFeed.fetch_data">
<a class="viewcode-back" href="../../portfolio_lib.core.html#portfolio_lib.core.YFinanceDataFeed.fetch_data">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">fetch_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start_date</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">end_date</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Alias for load_data that returns the data directly&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load_data</span><span class="p">(</span><span class="n">start_date</span><span class="p">,</span> <span class="n">end_date</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span></div>
</div>


<span class="k">class</span><span class="w"> </span><span class="nc">BaseIndicator</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Base class for technical indicators&quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">period</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">period</span> <span class="o">=</span> <span class="n">period</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        
    <span class="k">def</span><span class="w"> </span><span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Update indicator with new value&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">period</span> <span class="o">*</span> <span class="mi">2</span><span class="p">:</span>  <span class="c1"># Keep some history</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">period</span> <span class="o">*</span> <span class="mi">2</span><span class="p">:]</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">value</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get current indicator value&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">period</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate</span><span class="p">()</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_calculate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate indicator value - to be implemented by subclasses&quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

<span class="k">class</span><span class="w"> </span><span class="nc">SMA</span><span class="p">(</span><span class="n">BaseIndicator</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Simple Moving Average&quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_calculate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">period</span><span class="p">:])</span>

<span class="k">class</span><span class="w"> </span><span class="nc">EMA</span><span class="p">(</span><span class="n">BaseIndicator</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Exponential Moving Average&quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">period</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">period</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">/</span> <span class="p">(</span><span class="n">period</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ema_value</span> <span class="o">=</span> <span class="kc">None</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_calculate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ema_value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ema_value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">period</span><span class="p">:])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ema_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ema_value</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ema_value</span>

<span class="k">class</span><span class="w"> </span><span class="nc">RSI</span><span class="p">(</span><span class="n">BaseIndicator</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Relative Strength Index&quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_calculate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">period</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">50.0</span>
        
        <span class="n">deltas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">period</span><span class="o">-</span><span class="mi">1</span><span class="p">:])</span>
        <span class="n">gains</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">deltas</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">deltas</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">losses</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">deltas</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="n">deltas</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        
        <span class="n">avg_gain</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">gains</span><span class="p">)</span>
        <span class="n">avg_loss</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">losses</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">avg_loss</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">100.0</span>
        
        <span class="n">rs</span> <span class="o">=</span> <span class="n">avg_gain</span> <span class="o">/</span> <span class="n">avg_loss</span>
        <span class="n">rsi</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">-</span> <span class="p">(</span><span class="mi">100</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">rs</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">rsi</span>

<span class="k">class</span><span class="w"> </span><span class="nc">MACD</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Moving Average Convergence Divergence&quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fast_period</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">12</span><span class="p">,</span> <span class="n">slow_period</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">26</span><span class="p">,</span> <span class="n">signal_period</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">9</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fast_ema</span> <span class="o">=</span> <span class="n">EMA</span><span class="p">(</span><span class="n">fast_period</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slow_ema</span> <span class="o">=</span> <span class="n">EMA</span><span class="p">(</span><span class="n">slow_period</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">signal_ema</span> <span class="o">=</span> <span class="n">EMA</span><span class="p">(</span><span class="n">signal_period</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">macd_values</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fast_ema</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slow_ema</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fast_ema</span><span class="o">.</span><span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">slow_ema</span><span class="o">.</span><span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">macd_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fast_ema</span><span class="o">.</span><span class="n">value</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">slow_ema</span><span class="o">.</span><span class="n">value</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">macd_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">macd_value</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">signal_ema</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">macd_value</span><span class="p">)</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">macd</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">macd_values</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">macd_values</span> <span class="k">else</span> <span class="kc">None</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">signal</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">signal_ema</span><span class="o">.</span><span class="n">value</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">histogram</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">macd</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">signal</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">macd</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">signal</span>
        <span class="k">return</span> <span class="kc">None</span>

<span class="k">class</span><span class="w"> </span><span class="nc">BollingerBands</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Bollinger Bands indicator&quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">period</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span> <span class="n">std_dev</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">2.0</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">period</span> <span class="o">=</span> <span class="n">period</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">std_dev</span> <span class="o">=</span> <span class="n">std_dev</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">period</span> <span class="o">*</span> <span class="mi">2</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">period</span> <span class="o">*</span> <span class="mi">2</span><span class="p">:]</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">middle_band</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">period</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">period</span><span class="p">:])</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">upper_band</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
        <span class="n">middle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">middle_band</span>
        <span class="k">if</span> <span class="n">middle</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">period</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">period</span><span class="p">:])</span>
        <span class="k">return</span> <span class="n">middle</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">std_dev</span> <span class="o">*</span> <span class="n">std</span><span class="p">)</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">lower_band</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
        <span class="n">middle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">middle_band</span>
        <span class="k">if</span> <span class="n">middle</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">period</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">period</span><span class="p">:])</span>
        <span class="k">return</span> <span class="n">middle</span> <span class="o">-</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">std_dev</span> <span class="o">*</span> <span class="n">std</span><span class="p">)</span>

<span class="c1"># ============================================================================</span>
<span class="c1"># TREND INDICATORS</span>
<span class="c1"># ============================================================================</span>

<span class="k">class</span><span class="w"> </span><span class="nc">WMA</span><span class="p">(</span><span class="n">BaseIndicator</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Weighted Moving Average&quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_calculate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">period</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">period</span><span class="p">:],</span> <span class="n">weights</span><span class="o">=</span><span class="n">weights</span><span class="p">)</span>

<span class="k">class</span><span class="w"> </span><span class="nc">DEMA</span><span class="p">(</span><span class="n">BaseIndicator</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Double Exponential Moving Average&quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">period</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">period</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ema1</span> <span class="o">=</span> <span class="n">EMA</span><span class="p">(</span><span class="n">period</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ema2</span> <span class="o">=</span> <span class="n">EMA</span><span class="p">(</span><span class="n">period</span><span class="p">)</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ema1</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ema1</span><span class="o">.</span><span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ema2</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ema1</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_calculate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ema1</span><span class="o">.</span><span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">ema2</span><span class="o">.</span><span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">period</span><span class="p">:])</span>
        <span class="k">return</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ema1</span><span class="o">.</span><span class="n">value</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">ema2</span><span class="o">.</span><span class="n">value</span>

<span class="k">class</span><span class="w"> </span><span class="nc">TEMA</span><span class="p">(</span><span class="n">BaseIndicator</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Triple Exponential Moving Average&quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">period</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">period</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ema1</span> <span class="o">=</span> <span class="n">EMA</span><span class="p">(</span><span class="n">period</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ema2</span> <span class="o">=</span> <span class="n">EMA</span><span class="p">(</span><span class="n">period</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ema3</span> <span class="o">=</span> <span class="n">EMA</span><span class="p">(</span><span class="n">period</span><span class="p">)</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ema1</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ema1</span><span class="o">.</span><span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ema2</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ema1</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ema2</span><span class="o">.</span><span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ema3</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ema2</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_calculate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="k">if</span> <span class="kc">None</span> <span class="ow">in</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ema1</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ema2</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ema3</span><span class="o">.</span><span class="n">value</span><span class="p">]:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">period</span><span class="p">:])</span>
        <span class="k">return</span> <span class="mi">3</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ema1</span><span class="o">.</span><span class="n">value</span> <span class="o">-</span> <span class="mi">3</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ema2</span><span class="o">.</span><span class="n">value</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ema3</span><span class="o">.</span><span class="n">value</span>

<span class="k">class</span><span class="w"> </span><span class="nc">KAMA</span><span class="p">(</span><span class="n">BaseIndicator</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Kaufman Adaptive Moving Average&quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">period</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">fast_sc</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">slow_sc</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">30</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">period</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fast_sc</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">/</span> <span class="p">(</span><span class="n">fast_sc</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slow_sc</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">/</span> <span class="p">(</span><span class="n">slow_sc</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kama_value</span> <span class="o">=</span> <span class="kc">None</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_calculate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">period</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
        
        <span class="n">change</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">period</span><span class="p">])</span>
        <span class="n">volatility</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">period</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        
        <span class="k">if</span> <span class="n">volatility</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">er</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">er</span> <span class="o">=</span> <span class="n">change</span> <span class="o">/</span> <span class="n">volatility</span>
        
        <span class="n">sc</span> <span class="o">=</span> <span class="p">(</span><span class="n">er</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fast_sc</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">slow_sc</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">slow_sc</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">kama_value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">kama_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">kama_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kama_value</span> <span class="o">+</span> <span class="n">sc</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">kama_value</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">kama_value</span>

<span class="k">class</span><span class="w"> </span><span class="nc">HullMA</span><span class="p">(</span><span class="n">BaseIndicator</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Hull Moving Average&quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">period</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">period</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wma_half</span> <span class="o">=</span> <span class="n">WMA</span><span class="p">(</span><span class="n">period</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wma_full</span> <span class="o">=</span> <span class="n">WMA</span><span class="p">(</span><span class="n">period</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wma_sqrt</span> <span class="o">=</span> <span class="n">WMA</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">period</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hull_values</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wma_half</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wma_full</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">wma_half</span><span class="o">.</span><span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">wma_full</span><span class="o">.</span><span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">hull_value</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">wma_half</span><span class="o">.</span><span class="n">value</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">wma_full</span><span class="o">.</span><span class="n">value</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hull_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hull_value</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hull_values</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">period</span><span class="p">))</span> <span class="o">*</span> <span class="mi">2</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">hull_values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hull_values</span><span class="p">[</span><span class="o">-</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">period</span><span class="p">))</span> <span class="o">*</span> <span class="mi">2</span><span class="p">:]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wma_sqrt</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">hull_value</span><span class="p">)</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_calculate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">wma_sqrt</span><span class="o">.</span><span class="n">value</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">wma_sqrt</span><span class="o">.</span><span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">period</span><span class="p">:])</span>

<span class="k">class</span><span class="w"> </span><span class="nc">VWAP</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Volume Weighted Average Price&quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">price_volume</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">volume_sum</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">values</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">price</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">volume</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">price_volume</span> <span class="o">+=</span> <span class="n">price</span> <span class="o">*</span> <span class="n">volume</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">volume_sum</span> <span class="o">+=</span> <span class="n">volume</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">volume_sum</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">price_volume</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">volume_sum</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">price</span><span class="p">)</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">value</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span> <span class="k">else</span> <span class="kc">None</span>

<span class="k">class</span><span class="w"> </span><span class="nc">ParabolicSAR</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Parabolic Stop and Reverse&quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">af_start</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.02</span><span class="p">,</span> <span class="n">af_increment</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.02</span><span class="p">,</span> <span class="n">af_max</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">af_start</span> <span class="o">=</span> <span class="n">af_start</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">af_increment</span> <span class="o">=</span> <span class="n">af_increment</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">af_max</span> <span class="o">=</span> <span class="n">af_max</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sar</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trend</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># 1 for up, -1 for down</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">af</span> <span class="o">=</span> <span class="n">af_start</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ep</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Extreme Point</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">highs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lows</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">high</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">low</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">close</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">highs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">high</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">low</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">highs</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sar</span> <span class="o">=</span> <span class="n">low</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ep</span> <span class="o">=</span> <span class="n">high</span>
            <span class="k">return</span>
        
        <span class="n">prev_sar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sar</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">trend</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># Uptrend</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sar</span> <span class="o">=</span> <span class="n">prev_sar</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">af</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ep</span> <span class="o">-</span> <span class="n">prev_sar</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">low</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sar</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">trend</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ep</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ep</span> <span class="o">=</span> <span class="n">low</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">af</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">af_start</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">high</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">ep</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ep</span> <span class="o">=</span> <span class="n">high</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">af</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">af</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">af_increment</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">af_max</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># Downtrend</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sar</span> <span class="o">=</span> <span class="n">prev_sar</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">af</span> <span class="o">*</span> <span class="p">(</span><span class="n">prev_sar</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">ep</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">high</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sar</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">trend</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ep</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ep</span> <span class="o">=</span> <span class="n">high</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">af</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">af_start</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">low</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">ep</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ep</span> <span class="o">=</span> <span class="n">low</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">af</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">af</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">af_increment</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">af_max</span><span class="p">)</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">value</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sar</span>

<span class="c1"># ============================================================================</span>
<span class="c1"># MOMENTUM INDICATORS</span>
<span class="c1"># ============================================================================</span>

<span class="k">class</span><span class="w"> </span><span class="nc">Stochastic</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Stochastic Oscillator&quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k_period</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">14</span><span class="p">,</span> <span class="n">d_period</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">k_period</span> <span class="o">=</span> <span class="n">k_period</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">d_period</span> <span class="o">=</span> <span class="n">d_period</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">highs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lows</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">closes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">k_values</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">d_sma</span> <span class="o">=</span> <span class="n">SMA</span><span class="p">(</span><span class="n">d_period</span><span class="p">)</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">high</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">low</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">close</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">highs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">high</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">low</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">closes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">close</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">highs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_period</span> <span class="o">*</span> <span class="mi">2</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">highs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">highs</span><span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">k_period</span> <span class="o">*</span> <span class="mi">2</span><span class="p">:]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lows</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lows</span><span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">k_period</span> <span class="o">*</span> <span class="mi">2</span><span class="p">:]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">closes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">closes</span><span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">k_period</span> <span class="o">*</span> <span class="mi">2</span><span class="p">:]</span>
        
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">closes</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_period</span><span class="p">:</span>
            <span class="n">highest_high</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">highs</span><span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">k_period</span><span class="p">:])</span>
            <span class="n">lowest_low</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lows</span><span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">k_period</span><span class="p">:])</span>
            
            <span class="k">if</span> <span class="n">highest_high</span> <span class="o">-</span> <span class="n">lowest_low</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">k_value</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">*</span> <span class="p">(</span><span class="n">close</span> <span class="o">-</span> <span class="n">lowest_low</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">highest_high</span> <span class="o">-</span> <span class="n">lowest_low</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">k_value</span> <span class="o">=</span> <span class="mi">50</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">k_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k_value</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">d_sma</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">k_value</span><span class="p">)</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">k</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_values</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_values</span> <span class="k">else</span> <span class="kc">None</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">d</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">d_sma</span><span class="o">.</span><span class="n">value</span>

<span class="k">class</span><span class="w"> </span><span class="nc">WilliamsR</span><span class="p">(</span><span class="n">BaseIndicator</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Williams %R&quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">period</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">14</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">period</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">highs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lows</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">update_hlc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">high</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">low</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">close</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">highs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">high</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">low</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">close</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">period</span> <span class="o">*</span> <span class="mi">2</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">highs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">highs</span><span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">period</span> <span class="o">*</span> <span class="mi">2</span><span class="p">:]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lows</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lows</span><span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">period</span> <span class="o">*</span> <span class="mi">2</span><span class="p">:]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">period</span> <span class="o">*</span> <span class="mi">2</span><span class="p">:]</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_calculate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">period</span><span class="p">:</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">50</span>
        
        <span class="n">highest_high</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">highs</span><span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">period</span><span class="p">:])</span>
        <span class="n">lowest_low</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lows</span><span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">period</span><span class="p">:])</span>
        <span class="n">close</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="n">highest_high</span> <span class="o">-</span> <span class="n">lowest_low</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">100</span> <span class="o">*</span> <span class="p">(</span><span class="n">highest_high</span> <span class="o">-</span> <span class="n">close</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">highest_high</span> <span class="o">-</span> <span class="n">lowest_low</span><span class="p">)</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">50</span>

<span class="k">class</span><span class="w"> </span><span class="nc">CCI</span><span class="p">(</span><span class="n">BaseIndicator</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Commodity Channel Index&quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">period</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">period</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">highs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lows</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">closes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">typical_prices</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">update_hlc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">high</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">low</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">close</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">highs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">high</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">low</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">closes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">close</span><span class="p">)</span>
        
        <span class="n">typical_price</span> <span class="o">=</span> <span class="p">(</span><span class="n">high</span> <span class="o">+</span> <span class="n">low</span> <span class="o">+</span> <span class="n">close</span><span class="p">)</span> <span class="o">/</span> <span class="mi">3</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">typical_prices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">typical_price</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">typical_prices</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">period</span> <span class="o">*</span> <span class="mi">2</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">typical_prices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">typical_prices</span><span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">period</span> <span class="o">*</span> <span class="mi">2</span><span class="p">:]</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_calculate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">typical_prices</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">period</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>
        
        <span class="n">tp_sma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">typical_prices</span><span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">period</span><span class="p">:])</span>
        <span class="n">mean_deviation</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="nb">abs</span><span class="p">(</span><span class="n">tp</span> <span class="o">-</span> <span class="n">tp_sma</span><span class="p">)</span> <span class="k">for</span> <span class="n">tp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">typical_prices</span><span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">period</span><span class="p">:]])</span>
        
        <span class="k">if</span> <span class="n">mean_deviation</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>
        
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">typical_prices</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">tp_sma</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mf">0.015</span> <span class="o">*</span> <span class="n">mean_deviation</span><span class="p">)</span>

<span class="k">class</span><span class="w"> </span><span class="nc">ROC</span><span class="p">(</span><span class="n">BaseIndicator</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Rate of Change&quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_calculate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">period</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">period</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">period</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="mi">100</span>

<span class="k">class</span><span class="w"> </span><span class="nc">Momentum</span><span class="p">(</span><span class="n">BaseIndicator</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Momentum&quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_calculate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">period</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">period</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>

<span class="k">class</span><span class="w"> </span><span class="nc">StochasticRSI</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Stochastic RSI&quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rsi_period</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">14</span><span class="p">,</span> <span class="n">stoch_period</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">14</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rsi</span> <span class="o">=</span> <span class="n">RSI</span><span class="p">(</span><span class="n">rsi_period</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stoch_period</span> <span class="o">=</span> <span class="n">stoch_period</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rsi_values</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rsi</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rsi</span><span class="o">.</span><span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rsi_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rsi</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rsi_values</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">stoch_period</span> <span class="o">*</span> <span class="mi">2</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">rsi_values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rsi_values</span><span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">stoch_period</span> <span class="o">*</span> <span class="mi">2</span><span class="p">:]</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">value</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rsi_values</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">stoch_period</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        
        <span class="n">rsi_high</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rsi_values</span><span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">stoch_period</span><span class="p">:])</span>
        <span class="n">rsi_low</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rsi_values</span><span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">stoch_period</span><span class="p">:])</span>
        <span class="n">current_rsi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rsi_values</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="n">rsi_high</span> <span class="o">-</span> <span class="n">rsi_low</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">100</span> <span class="o">*</span> <span class="p">(</span><span class="n">current_rsi</span> <span class="o">-</span> <span class="n">rsi_low</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">rsi_high</span> <span class="o">-</span> <span class="n">rsi_low</span><span class="p">)</span>
        <span class="k">return</span> <span class="mi">50</span>

<span class="k">class</span><span class="w"> </span><span class="nc">TRIX</span><span class="p">(</span><span class="n">BaseIndicator</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;TRIX&quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">period</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">14</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">period</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ema1</span> <span class="o">=</span> <span class="n">EMA</span><span class="p">(</span><span class="n">period</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ema2</span> <span class="o">=</span> <span class="n">EMA</span><span class="p">(</span><span class="n">period</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ema3</span> <span class="o">=</span> <span class="n">EMA</span><span class="p">(</span><span class="n">period</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trix_values</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ema1</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ema1</span><span class="o">.</span><span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ema2</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ema1</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ema2</span><span class="o">.</span><span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ema3</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ema2</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trix_values</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">trix</span> <span class="o">=</span> <span class="mi">10000</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ema3</span><span class="o">.</span><span class="n">value</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">trix_values</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">trix_values</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">trix_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">trix</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">trix_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_calculate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">trix_values</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">trix_values</span> <span class="k">else</span> <span class="mi">0</span>

<span class="c1"># ============================================================================</span>
<span class="c1"># VOLATILITY INDICATORS</span>
<span class="c1"># ============================================================================</span>

<span class="k">class</span><span class="w"> </span><span class="nc">ATR</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Average True Range&quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">period</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">14</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">period</span> <span class="o">=</span> <span class="n">period</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tr_values</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">atr_sma</span> <span class="o">=</span> <span class="n">SMA</span><span class="p">(</span><span class="n">period</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prev_close</span> <span class="o">=</span> <span class="kc">None</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">high</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">low</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">close</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">prev_close</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">tr1</span> <span class="o">=</span> <span class="n">high</span> <span class="o">-</span> <span class="n">low</span>
            <span class="n">tr2</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">high</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">prev_close</span><span class="p">)</span>
            <span class="n">tr3</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">low</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">prev_close</span><span class="p">)</span>
            <span class="n">tr</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">tr1</span><span class="p">,</span> <span class="n">tr2</span><span class="p">,</span> <span class="n">tr3</span><span class="p">)</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">tr_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tr</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">atr_sma</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">tr</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">prev_close</span> <span class="o">=</span> <span class="n">close</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">value</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">atr_sma</span><span class="o">.</span><span class="n">value</span>

<span class="k">class</span><span class="w"> </span><span class="nc">TrueRange</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;True Range&quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prev_close</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tr_value</span> <span class="o">=</span> <span class="kc">None</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">high</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">low</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">close</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">prev_close</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">tr1</span> <span class="o">=</span> <span class="n">high</span> <span class="o">-</span> <span class="n">low</span>
            <span class="n">tr2</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">high</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">prev_close</span><span class="p">)</span>
            <span class="n">tr3</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">low</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">prev_close</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tr_value</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">tr1</span><span class="p">,</span> <span class="n">tr2</span><span class="p">,</span> <span class="n">tr3</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tr_value</span> <span class="o">=</span> <span class="n">high</span> <span class="o">-</span> <span class="n">low</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">prev_close</span> <span class="o">=</span> <span class="n">close</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">value</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tr_value</span>

<span class="k">class</span><span class="w"> </span><span class="nc">KeltnerChannels</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Keltner Channels&quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">period</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span> <span class="n">multiplier</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">2.0</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ema</span> <span class="o">=</span> <span class="n">EMA</span><span class="p">(</span><span class="n">period</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">atr</span> <span class="o">=</span> <span class="n">ATR</span><span class="p">(</span><span class="n">period</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">multiplier</span> <span class="o">=</span> <span class="n">multiplier</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">high</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">low</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">close</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ema</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">close</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">atr</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">high</span><span class="p">,</span> <span class="n">low</span><span class="p">,</span> <span class="n">close</span><span class="p">)</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">middle</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ema</span><span class="o">.</span><span class="n">value</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">upper</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ema</span><span class="o">.</span><span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">atr</span><span class="o">.</span><span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ema</span><span class="o">.</span><span class="n">value</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">multiplier</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">atr</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">lower</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ema</span><span class="o">.</span><span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">atr</span><span class="o">.</span><span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ema</span><span class="o">.</span><span class="n">value</span> <span class="o">-</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">multiplier</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">atr</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>

<span class="k">class</span><span class="w"> </span><span class="nc">DonchianChannels</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Donchian Channels&quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">period</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">period</span> <span class="o">=</span> <span class="n">period</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">highs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lows</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">high</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">low</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">highs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">high</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">low</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">highs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">period</span> <span class="o">*</span> <span class="mi">2</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">highs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">highs</span><span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">period</span> <span class="o">*</span> <span class="mi">2</span><span class="p">:]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lows</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lows</span><span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">period</span> <span class="o">*</span> <span class="mi">2</span><span class="p">:]</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">upper</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">highs</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">period</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">highs</span><span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">period</span><span class="p">:])</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">lower</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lows</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">period</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lows</span><span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">period</span><span class="p">:])</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">middle</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">upper</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">lower</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">upper</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">lower</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>

<span class="k">class</span><span class="w"> </span><span class="nc">ADX</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Average Directional Index&quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">period</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">14</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">period</span> <span class="o">=</span> <span class="n">period</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">atr</span> <span class="o">=</span> <span class="n">ATR</span><span class="p">(</span><span class="n">period</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plus_dm_sma</span> <span class="o">=</span> <span class="n">SMA</span><span class="p">(</span><span class="n">period</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">minus_dm_sma</span> <span class="o">=</span> <span class="n">SMA</span><span class="p">(</span><span class="n">period</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dx_values</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">adx_sma</span> <span class="o">=</span> <span class="n">SMA</span><span class="p">(</span><span class="n">period</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prev_high</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prev_low</span> <span class="o">=</span> <span class="kc">None</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">high</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">low</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">close</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">atr</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">high</span><span class="p">,</span> <span class="n">low</span><span class="p">,</span> <span class="n">close</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">prev_high</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">prev_low</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">plus_dm</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">high</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">prev_high</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">if</span> <span class="n">high</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">prev_high</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">prev_low</span> <span class="o">-</span> <span class="n">low</span> <span class="k">else</span> <span class="mi">0</span>
            <span class="n">minus_dm</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prev_low</span> <span class="o">-</span> <span class="n">low</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">prev_low</span> <span class="o">-</span> <span class="n">low</span> <span class="o">&gt;</span> <span class="n">high</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">prev_high</span> <span class="k">else</span> <span class="mi">0</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">plus_dm_sma</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">plus_dm</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">minus_dm_sma</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">minus_dm</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">atr</span><span class="o">.</span><span class="n">value</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">atr</span><span class="o">.</span><span class="n">value</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">plus_di</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">plus_dm_sma</span><span class="o">.</span><span class="n">value</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">atr</span><span class="o">.</span><span class="n">value</span>
                <span class="n">minus_di</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">minus_dm_sma</span><span class="o">.</span><span class="n">value</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">atr</span><span class="o">.</span><span class="n">value</span>
                
                <span class="k">if</span> <span class="n">plus_di</span> <span class="o">+</span> <span class="n">minus_di</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">dx</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">*</span> <span class="nb">abs</span><span class="p">(</span><span class="n">plus_di</span> <span class="o">-</span> <span class="n">minus_di</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">plus_di</span> <span class="o">+</span> <span class="n">minus_di</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dx_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dx</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">adx_sma</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">dx</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">prev_high</span> <span class="o">=</span> <span class="n">high</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prev_low</span> <span class="o">=</span> <span class="n">low</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">value</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">adx_sma</span><span class="o">.</span><span class="n">value</span>

<span class="c1"># ============================================================================</span>
<span class="c1"># VOLUME INDICATORS</span>
<span class="c1"># ============================================================================</span>

<span class="k">class</span><span class="w"> </span><span class="nc">OBV</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;On-Balance Volume&quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">obv_value</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prev_close</span> <span class="o">=</span> <span class="kc">None</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">close</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">volume</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">prev_close</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">close</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">prev_close</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">obv_value</span> <span class="o">+=</span> <span class="n">volume</span>
            <span class="k">elif</span> <span class="n">close</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">prev_close</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">obv_value</span> <span class="o">-=</span> <span class="n">volume</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">prev_close</span> <span class="o">=</span> <span class="n">close</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">value</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">obv_value</span>

<span class="k">class</span><span class="w"> </span><span class="nc">AccumulationDistribution</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Accumulation/Distribution Line&quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ad_value</span> <span class="o">=</span> <span class="mi">0</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">high</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">low</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">close</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">volume</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">high</span> <span class="o">!=</span> <span class="n">low</span><span class="p">:</span>
            <span class="n">ad_multiplier</span> <span class="o">=</span> <span class="p">((</span><span class="n">close</span> <span class="o">-</span> <span class="n">low</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">high</span> <span class="o">-</span> <span class="n">close</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="n">high</span> <span class="o">-</span> <span class="n">low</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ad_value</span> <span class="o">+=</span> <span class="n">ad_multiplier</span> <span class="o">*</span> <span class="n">volume</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">value</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ad_value</span>

<span class="k">class</span><span class="w"> </span><span class="nc">ChaikinMoneyFlow</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Chaikin Money Flow&quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">period</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">period</span> <span class="o">=</span> <span class="n">period</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">money_flow_multipliers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">volumes</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">high</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">low</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">close</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">volume</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">high</span> <span class="o">!=</span> <span class="n">low</span><span class="p">:</span>
            <span class="n">mf_multiplier</span> <span class="o">=</span> <span class="p">((</span><span class="n">close</span> <span class="o">-</span> <span class="n">low</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">high</span> <span class="o">-</span> <span class="n">close</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="n">high</span> <span class="o">-</span> <span class="n">low</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mf_multiplier</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">money_flow_multipliers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mf_multiplier</span> <span class="o">*</span> <span class="n">volume</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">volumes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">volume</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">money_flow_multipliers</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">period</span> <span class="o">*</span> <span class="mi">2</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">money_flow_multipliers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">money_flow_multipliers</span><span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">period</span> <span class="o">*</span> <span class="mi">2</span><span class="p">:]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">volumes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">volumes</span><span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">period</span> <span class="o">*</span> <span class="mi">2</span><span class="p">:]</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">value</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">money_flow_multipliers</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">period</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        
        <span class="n">sum_mf</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">money_flow_multipliers</span><span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">period</span><span class="p">:])</span>
        <span class="n">sum_volume</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">volumes</span><span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">period</span><span class="p">:])</span>
        
        <span class="k">return</span> <span class="n">sum_mf</span> <span class="o">/</span> <span class="n">sum_volume</span> <span class="k">if</span> <span class="n">sum_volume</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>

<span class="k">class</span><span class="w"> </span><span class="nc">VROC</span><span class="p">(</span><span class="n">BaseIndicator</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Volume Rate of Change&quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">period</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">25</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">period</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">volumes</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">update_volume</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">volume</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">volumes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">volume</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">volumes</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">period</span> <span class="o">*</span> <span class="mi">2</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">volumes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">volumes</span><span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">period</span> <span class="o">*</span> <span class="mi">2</span><span class="p">:]</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_calculate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">volumes</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">period</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>
        
        <span class="n">current_volume</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">volumes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">past_volume</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">volumes</span><span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">period</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="n">past_volume</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">((</span><span class="n">current_volume</span> <span class="o">-</span> <span class="n">past_volume</span><span class="p">)</span> <span class="o">/</span> <span class="n">past_volume</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
        <span class="k">return</span> <span class="mi">0</span>

<span class="k">class</span><span class="w"> </span><span class="nc">ForceIndex</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Force Index&quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">period</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">13</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ema</span> <span class="o">=</span> <span class="n">EMA</span><span class="p">(</span><span class="n">period</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prev_close</span> <span class="o">=</span> <span class="kc">None</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">close</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">volume</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">prev_close</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fi</span> <span class="o">=</span> <span class="n">volume</span> <span class="o">*</span> <span class="p">(</span><span class="n">close</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">prev_close</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ema</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">fi</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">prev_close</span> <span class="o">=</span> <span class="n">close</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">value</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ema</span><span class="o">.</span><span class="n">value</span>

<span class="k">class</span><span class="w"> </span><span class="nc">VWMA</span><span class="p">(</span><span class="n">BaseIndicator</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Volume Weighted Moving Average&quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">period</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">period</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">volumes</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">update_with_volume</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">price</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">volume</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">price</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">volumes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">volume</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">period</span> <span class="o">*</span> <span class="mi">2</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">period</span> <span class="o">*</span> <span class="mi">2</span><span class="p">:]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">volumes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">volumes</span><span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">period</span> <span class="o">*</span> <span class="mi">2</span><span class="p">:]</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_calculate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">period</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
        
        <span class="n">prices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">period</span><span class="p">:]</span>
        <span class="n">volumes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">volumes</span><span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">period</span><span class="p">:]</span>
        
        <span class="n">total_volume</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">volumes</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">total_volume</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">prices</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">p</span> <span class="o">*</span> <span class="n">v</span> <span class="k">for</span> <span class="n">p</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">prices</span><span class="p">,</span> <span class="n">volumes</span><span class="p">))</span> <span class="o">/</span> <span class="n">total_volume</span>

<span class="c1"># ============================================================================</span>
<span class="c1"># STATISTICAL INDICATORS</span>
<span class="c1"># ============================================================================</span>

<span class="k">class</span><span class="w"> </span><span class="nc">StandardDeviation</span><span class="p">(</span><span class="n">BaseIndicator</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Standard Deviation&quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_calculate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">period</span><span class="p">:])</span>

<span class="k">class</span><span class="w"> </span><span class="nc">Variance</span><span class="p">(</span><span class="n">BaseIndicator</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Variance&quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_calculate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">period</span><span class="p">:])</span>

<span class="k">class</span><span class="w"> </span><span class="nc">ZScore</span><span class="p">(</span><span class="n">BaseIndicator</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Z-Score&quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_calculate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">period</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>
        
        <span class="n">mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">period</span><span class="p">:])</span>
        <span class="n">std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">period</span><span class="p">:])</span>
        
        <span class="k">if</span> <span class="n">std</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>
        
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">mean</span><span class="p">)</span> <span class="o">/</span> <span class="n">std</span>

<span class="k">class</span><span class="w"> </span><span class="nc">LinearRegression</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Linear Regression&quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">period</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">period</span> <span class="o">=</span> <span class="n">period</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">values</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">period</span> <span class="o">*</span> <span class="mi">2</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">period</span> <span class="o">*</span> <span class="mi">2</span><span class="p">:]</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">slope</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">period</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        
        <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">period</span><span class="p">:])</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">))</span>
        
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">intercept</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">period</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        
        <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">period</span><span class="p">:])</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">))</span>
        
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">value</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">slope</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">intercept</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">slope</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">period</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">intercept</span>

<span class="k">class</span><span class="w"> </span><span class="nc">Correlation</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Correlation between two series&quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">period</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">period</span> <span class="o">=</span> <span class="n">period</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x_values</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y_values</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_values</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">period</span> <span class="o">*</span> <span class="mi">2</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">x_values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_values</span><span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">period</span> <span class="o">*</span> <span class="mi">2</span><span class="p">:]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">y_values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_values</span><span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">period</span> <span class="o">*</span> <span class="mi">2</span><span class="p">:]</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">value</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_values</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">period</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_values</span><span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">period</span><span class="p">:])</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y_values</span><span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">period</span><span class="p">:])</span>
        
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>

<span class="c1"># ============================================================================</span>
<span class="c1"># PATTERN INDICATORS</span>
<span class="c1"># ============================================================================</span>

<span class="k">class</span><span class="w"> </span><span class="nc">PivotPoints</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Pivot Points&quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pivot</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">r1</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">r2</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">r3</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">s1</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">s2</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">s3</span> <span class="o">=</span> <span class="kc">None</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">high</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">low</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">close</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pivot</span> <span class="o">=</span> <span class="p">(</span><span class="n">high</span> <span class="o">+</span> <span class="n">low</span> <span class="o">+</span> <span class="n">close</span><span class="p">)</span> <span class="o">/</span> <span class="mi">3</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">r1</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">pivot</span> <span class="o">-</span> <span class="n">low</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">s1</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">pivot</span> <span class="o">-</span> <span class="n">high</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">r2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pivot</span> <span class="o">+</span> <span class="p">(</span><span class="n">high</span> <span class="o">-</span> <span class="n">low</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">s2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pivot</span> <span class="o">-</span> <span class="p">(</span><span class="n">high</span> <span class="o">-</span> <span class="n">low</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">r3</span> <span class="o">=</span> <span class="n">high</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pivot</span> <span class="o">-</span> <span class="n">low</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">s3</span> <span class="o">=</span> <span class="n">low</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">high</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">pivot</span><span class="p">)</span>

<span class="k">class</span><span class="w"> </span><span class="nc">FibonacciRetracement</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Fibonacci Retracement&quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">high</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">low</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">levels</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.236</span><span class="p">,</span> <span class="mf">0.382</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.618</span><span class="p">,</span> <span class="mf">0.786</span><span class="p">]</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">high</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">low</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">high</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">high</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">high</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">high</span> <span class="o">=</span> <span class="n">high</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">low</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">low</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">low</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">low</span> <span class="o">=</span> <span class="n">low</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">get_retracement_levels</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">high</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">low</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{}</span>
        
        <span class="n">diff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">high</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">low</span>
        <span class="n">levels</span> <span class="o">=</span> <span class="p">{}</span>
        
        <span class="k">for</span> <span class="n">level</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">levels</span><span class="p">:</span>
            <span class="n">levels</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">level</span><span class="si">:</span><span class="s2">.1%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">high</span> <span class="o">-</span> <span class="p">(</span><span class="n">diff</span> <span class="o">*</span> <span class="n">level</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">levels</span>

<span class="k">class</span><span class="w"> </span><span class="nc">ZigZag</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;ZigZag Indicator&quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">deviation</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">5.0</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">deviation</span> <span class="o">=</span> <span class="n">deviation</span> <span class="o">/</span> <span class="mi">100</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">highs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lows</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_pivot</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_pivot_type</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># &#39;high&#39; or &#39;low&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_trend</span> <span class="o">=</span> <span class="kc">None</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">high</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">low</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">close</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">highs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">high</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">low</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_pivot</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">last_pivot</span> <span class="o">=</span> <span class="n">close</span>
            <span class="k">return</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_pivot_type</span> <span class="o">==</span> <span class="s1">&#39;high&#39;</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_pivot_type</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">low</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_pivot</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">deviation</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">last_pivot</span> <span class="o">=</span> <span class="n">low</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">last_pivot_type</span> <span class="o">=</span> <span class="s1">&#39;low&#39;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">current_trend</span> <span class="o">=</span> <span class="s1">&#39;down&#39;</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_pivot_type</span> <span class="o">==</span> <span class="s1">&#39;low&#39;</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_pivot_type</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">high</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_pivot</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">deviation</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">last_pivot</span> <span class="o">=</span> <span class="n">high</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">last_pivot_type</span> <span class="o">=</span> <span class="s1">&#39;high&#39;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">current_trend</span> <span class="o">=</span> <span class="s1">&#39;up&#39;</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">trend</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_trend</span>

<span class="c1"># ============================================================================</span>
<span class="c1"># ADVANCED MOMENTUM INDICATORS</span>
<span class="c1"># ============================================================================</span>

<span class="k">class</span><span class="w"> </span><span class="nc">UltimateOscillator</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Ultimate Oscillator&quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">period1</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">7</span><span class="p">,</span> <span class="n">period2</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">14</span><span class="p">,</span> <span class="n">period3</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">28</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">period1</span> <span class="o">=</span> <span class="n">period1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">period2</span> <span class="o">=</span> <span class="n">period2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">period3</span> <span class="o">=</span> <span class="n">period3</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bp_values</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># Buying Pressure</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tr_values</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># True Range</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prev_close</span> <span class="o">=</span> <span class="kc">None</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">high</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">low</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">close</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">prev_close</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">bp</span> <span class="o">=</span> <span class="n">close</span> <span class="o">-</span> <span class="nb">min</span><span class="p">(</span><span class="n">low</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">prev_close</span><span class="p">)</span>
            <span class="n">tr</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">high</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">prev_close</span><span class="p">)</span> <span class="o">-</span> <span class="nb">min</span><span class="p">(</span><span class="n">low</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">prev_close</span><span class="p">)</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">bp_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tr_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tr</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bp_values</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">period3</span> <span class="o">*</span> <span class="mi">2</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bp_values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bp_values</span><span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">period3</span> <span class="o">*</span> <span class="mi">2</span><span class="p">:]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tr_values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tr_values</span><span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">period3</span> <span class="o">*</span> <span class="mi">2</span><span class="p">:]</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">prev_close</span> <span class="o">=</span> <span class="n">close</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">value</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bp_values</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">period3</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        
        <span class="n">avg1</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bp_values</span><span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">period1</span><span class="p">:])</span> <span class="o">/</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tr_values</span><span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">period1</span><span class="p">:])</span> <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tr_values</span><span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">period1</span><span class="p">:])</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="n">avg2</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bp_values</span><span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">period2</span><span class="p">:])</span> <span class="o">/</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tr_values</span><span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">period2</span><span class="p">:])</span> <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tr_values</span><span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">period2</span><span class="p">:])</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="n">avg3</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bp_values</span><span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">period3</span><span class="p">:])</span> <span class="o">/</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tr_values</span><span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">period3</span><span class="p">:])</span> <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tr_values</span><span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">period3</span><span class="p">:])</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
        
        <span class="k">return</span> <span class="mi">100</span> <span class="o">*</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">avg1</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">avg2</span> <span class="o">+</span> <span class="n">avg3</span><span class="p">)</span> <span class="o">/</span> <span class="mi">7</span>

<span class="k">class</span><span class="w"> </span><span class="nc">AwesomeOscillator</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Awesome Oscillator&quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fast_period</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span> <span class="n">slow_period</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">34</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fast_sma</span> <span class="o">=</span> <span class="n">SMA</span><span class="p">(</span><span class="n">fast_period</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slow_sma</span> <span class="o">=</span> <span class="n">SMA</span><span class="p">(</span><span class="n">slow_period</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hl2_values</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">high</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">low</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
        <span class="n">hl2</span> <span class="o">=</span> <span class="p">(</span><span class="n">high</span> <span class="o">+</span> <span class="n">low</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hl2_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hl2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fast_sma</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">hl2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slow_sma</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">hl2</span><span class="p">)</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">value</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fast_sma</span><span class="o">.</span><span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">slow_sma</span><span class="o">.</span><span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">fast_sma</span><span class="o">.</span><span class="n">value</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">slow_sma</span><span class="o">.</span><span class="n">value</span>

<span class="k">class</span><span class="w"> </span><span class="nc">WavesTrend</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;WavesTrend Oscillator&quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">period1</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">period2</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">21</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">period1</span> <span class="o">=</span> <span class="n">period1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">period2</span> <span class="o">=</span> <span class="n">period2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">esa</span> <span class="o">=</span> <span class="n">EMA</span><span class="p">(</span><span class="n">period1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">d_ema</span> <span class="o">=</span> <span class="n">EMA</span><span class="p">(</span><span class="n">period1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ci_ema</span> <span class="o">=</span> <span class="n">EMA</span><span class="p">(</span><span class="n">period2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tci_values</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">high</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">low</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">close</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
        <span class="n">hlc3</span> <span class="o">=</span> <span class="p">(</span><span class="n">high</span> <span class="o">+</span> <span class="n">low</span> <span class="o">+</span> <span class="n">close</span><span class="p">)</span> <span class="o">/</span> <span class="mi">3</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">esa</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">hlc3</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">esa</span><span class="o">.</span><span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">d</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">hlc3</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">esa</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">d_ema</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">d_ema</span><span class="o">.</span><span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">d_ema</span><span class="o">.</span><span class="n">value</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">ci</span> <span class="o">=</span> <span class="p">(</span><span class="n">hlc3</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">esa</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mf">0.015</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">d_ema</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ci_ema</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">ci</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tci_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ci</span><span class="p">)</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">value</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ci_ema</span><span class="o">.</span><span class="n">value</span>

<span class="k">class</span><span class="w"> </span><span class="nc">DeMarker</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;DeMarker Indicator&quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">period</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">14</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">period</span> <span class="o">=</span> <span class="n">period</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">demax_values</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">demin_values</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prev_high</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prev_low</span> <span class="o">=</span> <span class="kc">None</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">high</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">low</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">prev_high</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">prev_low</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">demax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">high</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">prev_high</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">demin</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prev_low</span> <span class="o">-</span> <span class="n">low</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">demax_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">demax</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">demin_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">demin</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">demax_values</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">period</span> <span class="o">*</span> <span class="mi">2</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">demax_values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">demax_values</span><span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">period</span> <span class="o">*</span> <span class="mi">2</span><span class="p">:]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">demin_values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">demin_values</span><span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">period</span> <span class="o">*</span> <span class="mi">2</span><span class="p">:]</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">prev_high</span> <span class="o">=</span> <span class="n">high</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prev_low</span> <span class="o">=</span> <span class="n">low</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">value</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">demax_values</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">period</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        
        <span class="n">avg_demax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">demax_values</span><span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">period</span><span class="p">:])</span>
        <span class="n">avg_demin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">demin_values</span><span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">period</span><span class="p">:])</span>
        
        <span class="k">if</span> <span class="n">avg_demax</span> <span class="o">+</span> <span class="n">avg_demin</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">0.5</span>
        
        <span class="k">return</span> <span class="n">avg_demax</span> <span class="o">/</span> <span class="p">(</span><span class="n">avg_demax</span> <span class="o">+</span> <span class="n">avg_demin</span><span class="p">)</span>

<span class="k">class</span><span class="w"> </span><span class="nc">AroonIndicator</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Aroon Indicator&quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">period</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">25</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">period</span> <span class="o">=</span> <span class="n">period</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">highs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lows</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">high</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">low</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">highs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">high</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">low</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">highs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">period</span> <span class="o">*</span> <span class="mi">2</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">highs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">highs</span><span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">period</span> <span class="o">*</span> <span class="mi">2</span><span class="p">:]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lows</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lows</span><span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">period</span> <span class="o">*</span> <span class="mi">2</span><span class="p">:]</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">aroon_up</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">highs</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">period</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        
        <span class="n">max_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">highs</span><span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">period</span><span class="p">:])</span>
        <span class="k">return</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">period</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">max_idx</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">period</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">*</span> <span class="mi">100</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">aroon_down</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lows</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">period</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        
        <span class="n">min_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lows</span><span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">period</span><span class="p">:])</span>
        <span class="k">return</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">period</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">min_idx</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">period</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">*</span> <span class="mi">100</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">aroon_oscillator</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">aroon_up</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">aroon_down</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">aroon_up</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">aroon_down</span>

<span class="c1"># ============================================================================</span>
<span class="c1"># ADDITIONAL TREND INDICATORS</span>
<span class="c1"># ============================================================================</span>

<span class="k">class</span><span class="w"> </span><span class="nc">McGinleyDynamic</span><span class="p">(</span><span class="n">BaseIndicator</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;McGinley Dynamic&quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">period</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">period</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">md_value</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">k</span> <span class="o">=</span> <span class="mf">0.6</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_calculate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">md_value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">md_value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">md_factor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">md_value</span>
            <span class="n">n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">period</span> <span class="o">*</span> <span class="p">(</span><span class="n">md_factor</span> <span class="o">**</span> <span class="mi">4</span><span class="p">)</span>
            <span class="n">alpha</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">/</span> <span class="p">(</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">md_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">md_value</span> <span class="o">+</span> <span class="n">alpha</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">md_value</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">md_value</span>

<span class="k">class</span><span class="w"> </span><span class="nc">VerticalHorizontalFilter</span><span class="p">(</span><span class="n">BaseIndicator</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Vertical Horizontal Filter&quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_calculate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">period</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>
        
        <span class="n">numerator</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">period</span><span class="p">])</span>
        <span class="n">denominator</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> 
                         <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">period</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        
        <span class="k">return</span> <span class="n">numerator</span> <span class="o">/</span> <span class="n">denominator</span> <span class="k">if</span> <span class="n">denominator</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>

<span class="k">class</span><span class="w"> </span><span class="nc">SuperTrend</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;SuperTrend Indicator&quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">period</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">multiplier</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">3.0</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">period</span> <span class="o">=</span> <span class="n">period</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">multiplier</span> <span class="o">=</span> <span class="n">multiplier</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">atr</span> <span class="o">=</span> <span class="n">ATR</span><span class="p">(</span><span class="n">period</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">basic_ub</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">basic_lb</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">final_ub</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">final_lb</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">supertrend</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trend</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">high</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">low</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">close</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
        <span class="n">hl2</span> <span class="o">=</span> <span class="p">(</span><span class="n">high</span> <span class="o">+</span> <span class="n">low</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">atr</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">high</span><span class="p">,</span> <span class="n">low</span><span class="p">,</span> <span class="n">close</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">atr</span><span class="o">.</span><span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">basic_ub</span> <span class="o">=</span> <span class="n">hl2</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">multiplier</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">atr</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
            <span class="n">basic_lb</span> <span class="o">=</span> <span class="n">hl2</span> <span class="o">-</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">multiplier</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">atr</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">basic_ub</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">basic_ub</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">basic_lb</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">basic_lb</span><span class="p">)</span>
            
            <span class="c1"># Calculate final bands</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">final_ub</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">final_ub</span> <span class="o">=</span> <span class="n">basic_ub</span>
                <span class="n">final_lb</span> <span class="o">=</span> <span class="n">basic_lb</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">final_ub</span> <span class="o">=</span> <span class="n">basic_ub</span> <span class="k">if</span> <span class="n">basic_ub</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">final_ub</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">or</span> <span class="n">close</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">final_ub</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">final_ub</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">final_lb</span> <span class="o">=</span> <span class="n">basic_lb</span> <span class="k">if</span> <span class="n">basic_lb</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">final_lb</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">or</span> <span class="n">close</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">final_lb</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">final_lb</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">final_ub</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">final_ub</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">final_lb</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">final_lb</span><span class="p">)</span>
            
            <span class="c1"># Determine trend and SuperTrend</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">supertrend</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">close</span> <span class="o">&lt;=</span> <span class="n">final_ub</span><span class="p">:</span>
                    <span class="n">supertrend</span> <span class="o">=</span> <span class="n">final_ub</span>
                    <span class="n">trend</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">supertrend</span> <span class="o">=</span> <span class="n">final_lb</span>
                    <span class="n">trend</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">prev_supertrend</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">supertrend</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">prev_trend</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trend</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                
                <span class="k">if</span> <span class="n">prev_trend</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">close</span> <span class="o">&gt;</span> <span class="n">final_lb</span><span class="p">:</span>
                    <span class="n">supertrend</span> <span class="o">=</span> <span class="n">final_lb</span>
                    <span class="n">trend</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="k">elif</span> <span class="n">prev_trend</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">close</span> <span class="o">&lt;=</span> <span class="n">final_lb</span><span class="p">:</span>
                    <span class="n">supertrend</span> <span class="o">=</span> <span class="n">final_ub</span>
                    <span class="n">trend</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                <span class="k">elif</span> <span class="n">prev_trend</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">close</span> <span class="o">&lt;</span> <span class="n">final_ub</span><span class="p">:</span>
                    <span class="n">supertrend</span> <span class="o">=</span> <span class="n">final_ub</span>
                    <span class="n">trend</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">supertrend</span> <span class="o">=</span> <span class="n">final_lb</span>
                    <span class="n">trend</span> <span class="o">=</span> <span class="mi">1</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">supertrend</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">supertrend</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trend</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">trend</span><span class="p">)</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">value</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">supertrend</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">supertrend</span> <span class="k">else</span> <span class="kc">None</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">trend_direction</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">trend</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">trend</span> <span class="k">else</span> <span class="kc">None</span>

<span class="k">class</span><span class="w"> </span><span class="nc">AlmaIndicator</span><span class="p">(</span><span class="n">BaseIndicator</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Arnaud Legoux Moving Average (ALMA)&quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">period</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">9</span><span class="p">,</span> <span class="n">offset</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.85</span><span class="p">,</span> <span class="n">sigma</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">6</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">period</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">offset</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sigma</span> <span class="o">=</span> <span class="n">sigma</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weights</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_weights</span><span class="p">()</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_calculate_weights</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">offset</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">period</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">period</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigma</span>
        
        <span class="n">weights</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">period</span><span class="p">):</span>
            <span class="n">weights</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">((</span><span class="n">i</span> <span class="o">-</span> <span class="n">m</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">s</span> <span class="o">*</span> <span class="n">s</span><span class="p">)))</span>
        
        <span class="n">weight_sum</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">w</span> <span class="o">/</span> <span class="n">weight_sum</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">weights</span><span class="p">]</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_calculate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">period</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> 
                  <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">period</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>

<span class="c1"># ============================================================================</span>
<span class="c1"># VOLUME-PRICE INDICATORS</span>
<span class="c1"># ============================================================================</span>

<span class="k">class</span><span class="w"> </span><span class="nc">MoneyFlowIndex</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Money Flow Index&quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">period</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">14</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">period</span> <span class="o">=</span> <span class="n">period</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">typical_prices</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">raw_money_flows</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prev_tp</span> <span class="o">=</span> <span class="kc">None</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">high</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">low</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">close</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">volume</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
        <span class="n">tp</span> <span class="o">=</span> <span class="p">(</span><span class="n">high</span> <span class="o">+</span> <span class="n">low</span> <span class="o">+</span> <span class="n">close</span><span class="p">)</span> <span class="o">/</span> <span class="mi">3</span>
        <span class="n">raw_money_flow</span> <span class="o">=</span> <span class="n">tp</span> <span class="o">*</span> <span class="n">volume</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">typical_prices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tp</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">raw_money_flows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">raw_money_flow</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">typical_prices</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">period</span> <span class="o">*</span> <span class="mi">2</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">typical_prices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">typical_prices</span><span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">period</span> <span class="o">*</span> <span class="mi">2</span><span class="p">:]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">raw_money_flows</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw_money_flows</span><span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">period</span> <span class="o">*</span> <span class="mi">2</span><span class="p">:]</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">prev_tp</span> <span class="o">=</span> <span class="n">tp</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">value</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">typical_prices</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">period</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        
        <span class="n">positive_flow</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">negative_flow</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">period</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">period</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">typical_prices</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">typical_prices</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">positive_flow</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw_money_flows</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">typical_prices</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">typical_prices</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">negative_flow</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw_money_flows</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="n">negative_flow</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">100</span>
        
        <span class="n">money_ratio</span> <span class="o">=</span> <span class="n">positive_flow</span> <span class="o">/</span> <span class="n">negative_flow</span>
        <span class="k">return</span> <span class="mi">100</span> <span class="o">-</span> <span class="p">(</span><span class="mi">100</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">money_ratio</span><span class="p">))</span>

<span class="k">class</span><span class="w"> </span><span class="nc">VolumeOscillator</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Volume Oscillator&quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fast_period</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span> <span class="n">slow_period</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fast_sma</span> <span class="o">=</span> <span class="n">SMA</span><span class="p">(</span><span class="n">fast_period</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slow_sma</span> <span class="o">=</span> <span class="n">SMA</span><span class="p">(</span><span class="n">slow_period</span><span class="p">)</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">volume</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fast_sma</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">volume</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slow_sma</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">volume</span><span class="p">)</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">value</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fast_sma</span><span class="o">.</span><span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">slow_sma</span><span class="o">.</span><span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">slow_sma</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">fast_sma</span><span class="o">.</span><span class="n">value</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">slow_sma</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">slow_sma</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>

<span class="k">class</span><span class="w"> </span><span class="nc">EaseOfMovement</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Ease of Movement&quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">period</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">14</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">period</span> <span class="o">=</span> <span class="n">period</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eom_values</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sma</span> <span class="o">=</span> <span class="n">SMA</span><span class="p">(</span><span class="n">period</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prev_high</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prev_low</span> <span class="o">=</span> <span class="kc">None</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">high</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">low</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">volume</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">prev_high</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">prev_low</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">distance_moved</span> <span class="o">=</span> <span class="p">((</span><span class="n">high</span> <span class="o">+</span> <span class="n">low</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">prev_high</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">prev_low</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">scale</span> <span class="o">=</span> <span class="n">volume</span> <span class="o">/</span> <span class="p">(</span><span class="n">high</span> <span class="o">-</span> <span class="n">low</span><span class="p">)</span> <span class="k">if</span> <span class="n">high</span> <span class="o">!=</span> <span class="n">low</span> <span class="k">else</span> <span class="mi">0</span>
            
            <span class="n">eom</span> <span class="o">=</span> <span class="n">distance_moved</span> <span class="o">/</span> <span class="n">scale</span> <span class="k">if</span> <span class="n">scale</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">eom_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">eom</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sma</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">eom</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">prev_high</span> <span class="o">=</span> <span class="n">high</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prev_low</span> <span class="o">=</span> <span class="n">low</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">value</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sma</span><span class="o">.</span><span class="n">value</span>

<span class="k">class</span><span class="w"> </span><span class="nc">NegativeVolumeIndex</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Negative Volume Index&quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nvi</span> <span class="o">=</span> <span class="mi">100</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prev_close</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prev_volume</span> <span class="o">=</span> <span class="kc">None</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">close</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">volume</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">prev_close</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">prev_volume</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">volume</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">prev_volume</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">nvi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nvi</span> <span class="o">*</span> <span class="p">(</span><span class="n">close</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">prev_close</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">prev_close</span> <span class="o">=</span> <span class="n">close</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prev_volume</span> <span class="o">=</span> <span class="n">volume</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">value</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">nvi</span>

<span class="k">class</span><span class="w"> </span><span class="nc">PositiveVolumeIndex</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Positive Volume Index&quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pvi</span> <span class="o">=</span> <span class="mi">100</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prev_close</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prev_volume</span> <span class="o">=</span> <span class="kc">None</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">close</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">volume</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">prev_close</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">prev_volume</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">volume</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">prev_volume</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pvi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pvi</span> <span class="o">*</span> <span class="p">(</span><span class="n">close</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">prev_close</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">prev_close</span> <span class="o">=</span> <span class="n">close</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prev_volume</span> <span class="o">=</span> <span class="n">volume</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">value</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pvi</span>

<span class="c1"># ============================================================================</span>
<span class="c1"># VOLATILITY AND BANDS</span>
<span class="c1"># ============================================================================</span>

<span class="k">class</span><span class="w"> </span><span class="nc">StandardError</span><span class="p">(</span><span class="n">BaseIndicator</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Standard Error&quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_calculate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">period</span><span class="p">:])</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">period</span><span class="p">)</span>

<span class="k">class</span><span class="w"> </span><span class="nc">MeanDeviation</span><span class="p">(</span><span class="n">BaseIndicator</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Mean Deviation&quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_calculate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="n">mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">period</span><span class="p">:])</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="nb">abs</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">mean</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">period</span><span class="p">:]])</span>

<span class="k">class</span><span class="w"> </span><span class="nc">ChoppinessIndex</span><span class="p">(</span><span class="n">BaseIndicator</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Choppiness Index&quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">period</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">14</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">period</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">highs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lows</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">atr_values</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">update_hlc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">high</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">low</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">close</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">highs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">high</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">low</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">close</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">tr</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">high</span> <span class="o">-</span> <span class="n">low</span><span class="p">,</span> 
                    <span class="nb">abs</span><span class="p">(</span><span class="n">high</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]),</span> 
                    <span class="nb">abs</span><span class="p">(</span><span class="n">low</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">atr_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tr</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">highs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">period</span> <span class="o">*</span> <span class="mi">2</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">highs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">highs</span><span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">period</span> <span class="o">*</span> <span class="mi">2</span><span class="p">:]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lows</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lows</span><span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">period</span> <span class="o">*</span> <span class="mi">2</span><span class="p">:]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">atr_values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">atr_values</span><span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">period</span> <span class="o">*</span> <span class="mi">2</span><span class="p">:]</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_calculate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">highs</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">period</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atr_values</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">period</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">50</span>
        
        <span class="n">highest_high</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">highs</span><span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">period</span><span class="p">:])</span>
        <span class="n">lowest_low</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lows</span><span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">period</span><span class="p">:])</span>
        <span class="n">atr_sum</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atr_values</span><span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">period</span><span class="p">:])</span>
        
        <span class="k">if</span> <span class="n">highest_high</span> <span class="o">-</span> <span class="n">lowest_low</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">50</span>
        
        <span class="n">ci</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">atr_sum</span> <span class="o">/</span> <span class="p">(</span><span class="n">highest_high</span> <span class="o">-</span> <span class="n">lowest_low</span><span class="p">))</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">period</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ci</span>

<span class="k">class</span><span class="w"> </span><span class="nc">RelativeVolatilityIndex</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Relative Volatility Index&quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">period</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">period</span> <span class="o">=</span> <span class="n">period</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">price_changes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">up_changes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">down_changes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">up_rsi</span> <span class="o">=</span> <span class="n">RSI</span><span class="p">(</span><span class="n">period</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">down_rsi</span> <span class="o">=</span> <span class="n">RSI</span><span class="p">(</span><span class="n">period</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prev_price</span> <span class="o">=</span> <span class="kc">None</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">price</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">prev_price</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">std_up</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">std_down</span> <span class="o">=</span> <span class="mi">0</span>
            
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">price_changes</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">9</span><span class="p">:</span>  <span class="c1"># Need at least 10 prices for std</span>
                <span class="n">recent_prices</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">prev_price</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">price_changes</span><span class="p">[</span><span class="o">-</span><span class="mi">8</span><span class="p">:]</span>
                <span class="n">std_dev</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">recent_prices</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="n">price</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">prev_price</span><span class="p">:</span>
                    <span class="n">std_up</span> <span class="o">=</span> <span class="n">std_dev</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">std_down</span> <span class="o">=</span> <span class="n">std_dev</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">up_rsi</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">std_up</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">down_rsi</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">std_down</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">price_changes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">price</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">prev_price</span> <span class="o">=</span> <span class="n">price</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">value</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">up_rsi</span><span class="o">.</span><span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">down_rsi</span><span class="o">.</span><span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">up_rsi</span><span class="o">.</span><span class="n">value</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">down_rsi</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>

<span class="c1"># ============================================================================</span>
<span class="c1"># MARKET STRUCTURE INDICATORS</span>
<span class="c1"># ============================================================================</span>

<span class="k">class</span><span class="w"> </span><span class="nc">SwingIndex</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Swing Index&quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prev_ohlc</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">si_values</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">open_price</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">high</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">low</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">close</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">prev_ohlc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">po</span><span class="p">,</span> <span class="n">ph</span><span class="p">,</span> <span class="n">pl</span><span class="p">,</span> <span class="n">pc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prev_ohlc</span>
            
            <span class="c1"># Calculate A, B, C components</span>
            <span class="n">a</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">high</span> <span class="o">-</span> <span class="n">pc</span><span class="p">)</span>
            <span class="n">b</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">low</span> <span class="o">-</span> <span class="n">pc</span><span class="p">)</span>
            <span class="n">c</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">high</span> <span class="o">-</span> <span class="n">low</span><span class="p">)</span>
            
            <span class="c1"># Calculate K</span>
            <span class="k">if</span> <span class="n">a</span> <span class="o">&gt;</span> <span class="n">b</span> <span class="ow">and</span> <span class="n">a</span> <span class="o">&gt;</span> <span class="n">c</span><span class="p">:</span>
                <span class="n">k</span> <span class="o">=</span> <span class="n">a</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">b</span> <span class="o">+</span> <span class="mf">0.25</span> <span class="o">*</span> <span class="p">(</span><span class="n">pc</span> <span class="o">-</span> <span class="n">po</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">b</span> <span class="o">&gt;</span> <span class="n">a</span> <span class="ow">and</span> <span class="n">b</span> <span class="o">&gt;</span> <span class="n">c</span><span class="p">:</span>
                <span class="n">k</span> <span class="o">=</span> <span class="n">b</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">a</span> <span class="o">+</span> <span class="mf">0.25</span> <span class="o">*</span> <span class="p">(</span><span class="n">pc</span> <span class="o">-</span> <span class="n">po</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">k</span> <span class="o">=</span> <span class="n">c</span> <span class="o">+</span> <span class="mf">0.25</span> <span class="o">*</span> <span class="p">(</span><span class="n">pc</span> <span class="o">-</span> <span class="n">po</span><span class="p">)</span>
            
            <span class="c1"># Calculate R</span>
            <span class="n">r</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">high</span> <span class="o">-</span> <span class="n">pc</span><span class="p">),</span> <span class="nb">abs</span><span class="p">(</span><span class="n">low</span> <span class="o">-</span> <span class="n">pc</span><span class="p">))</span>
            
            <span class="c1"># Calculate Swing Index</span>
            <span class="k">if</span> <span class="n">k</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">r</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">si</span> <span class="o">=</span> <span class="mi">50</span> <span class="o">*</span> <span class="p">((</span><span class="n">close</span> <span class="o">-</span> <span class="n">pc</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">close</span> <span class="o">-</span> <span class="n">open_price</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.25</span> <span class="o">*</span> <span class="p">(</span><span class="n">pc</span> <span class="o">-</span> <span class="n">po</span><span class="p">))</span> <span class="o">/</span> <span class="n">k</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">200</span> <span class="o">/</span> <span class="n">r</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">si</span> <span class="o">=</span> <span class="mi">0</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">si_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">si</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">prev_ohlc</span> <span class="o">=</span> <span class="p">(</span><span class="n">open_price</span><span class="p">,</span> <span class="n">high</span><span class="p">,</span> <span class="n">low</span><span class="p">,</span> <span class="n">close</span><span class="p">)</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">value</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">si_values</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">si_values</span> <span class="k">else</span> <span class="kc">None</span>

<span class="k">class</span><span class="w"> </span><span class="nc">AccumulativeSwingIndex</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Accumulative Swing Index&quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">swing_index</span> <span class="o">=</span> <span class="n">SwingIndex</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">asi_value</span> <span class="o">=</span> <span class="mi">0</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">open_price</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">high</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">low</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">close</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">swing_index</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">open_price</span><span class="p">,</span> <span class="n">high</span><span class="p">,</span> <span class="n">low</span><span class="p">,</span> <span class="n">close</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">swing_index</span><span class="o">.</span><span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">asi_value</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">swing_index</span><span class="o">.</span><span class="n">value</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">value</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">asi_value</span>

<span class="k">class</span><span class="w"> </span><span class="nc">FractalIndicator</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Fractal Indicator&quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">period</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">period</span> <span class="o">=</span> <span class="n">period</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">highs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lows</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bull_fractals</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bear_fractals</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">high</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">low</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">highs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">high</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">low</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">highs</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">period</span><span class="p">:</span>
            <span class="n">middle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">period</span> <span class="o">//</span> <span class="mi">2</span>
            
            <span class="c1"># Check for bullish fractal (high point)</span>
            <span class="n">is_bull_fractal</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">period</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">!=</span> <span class="n">middle</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">highs</span><span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">period</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">highs</span><span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">period</span> <span class="o">+</span> <span class="n">middle</span><span class="p">]:</span>
                    <span class="n">is_bull_fractal</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">break</span>
            
            <span class="c1"># Check for bearish fractal (low point)</span>
            <span class="n">is_bear_fractal</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">period</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">!=</span> <span class="n">middle</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">lows</span><span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">period</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lows</span><span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">period</span> <span class="o">+</span> <span class="n">middle</span><span class="p">]:</span>
                    <span class="n">is_bear_fractal</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">break</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">bull_fractals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">is_bull_fractal</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bear_fractals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">is_bear_fractal</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bull_fractals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bear_fractals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">is_bull_fractal</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">bull_fractals</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bull_fractals</span> <span class="k">else</span> <span class="kc">False</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">is_bear_fractal</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">bear_fractals</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bear_fractals</span> <span class="k">else</span> <span class="kc">False</span>

<span class="c1"># ============================================================================</span>
<span class="c1"># ADVANCED MATHEMATICAL INDICATORS</span>
<span class="c1"># ============================================================================</span>

<span class="k">class</span><span class="w"> </span><span class="nc">HilbertTransform</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Hilbert Transform - Dominant Cycle Period&quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prices</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">smooth_prices</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">detrender</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">i1</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">q1</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ji</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">jq</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">i2</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">q2</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">re</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">im</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">period</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">smooth_period</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">price</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">price</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prices</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">7</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">smooth_prices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">price</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">detrender</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">i1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">q1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ji</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">jq</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">i2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">q2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">re</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">im</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">period</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">smooth_period</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>
            <span class="k">return</span>
        
        <span class="c1"># Smooth the price</span>
        <span class="n">smooth</span> <span class="o">=</span> <span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="n">price</span> <span class="o">+</span> <span class="mi">3</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">prices</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">prices</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">prices</span><span class="p">[</span><span class="o">-</span><span class="mi">4</span><span class="p">])</span> <span class="o">/</span> <span class="mi">10</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">smooth_prices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">smooth</span><span class="p">)</span>
        
        <span class="c1"># Detrender</span>
        <span class="n">detrender_val</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.0962</span><span class="o">*</span><span class="n">smooth</span> <span class="o">+</span> <span class="mf">0.5769</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">smooth_prices</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> 
                        <span class="o">-</span> <span class="mf">0.5769</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">smooth_prices</span><span class="p">[</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.0962</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">smooth_prices</span><span class="p">[</span><span class="o">-</span><span class="mi">6</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">detrender</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">detrender_val</span><span class="p">)</span>
        
        <span class="c1"># Compute InPhase and Quadrature components</span>
        <span class="n">i1_val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">detrender</span><span class="p">[</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">detrender</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">4</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="n">q1_val</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.0962</span><span class="o">*</span><span class="n">detrender_val</span> <span class="o">+</span> <span class="mf">0.5769</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">detrender</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> 
                 <span class="o">-</span> <span class="mf">0.5769</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">detrender</span><span class="p">[</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.0962</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">detrender</span><span class="p">[</span><span class="o">-</span><span class="mi">6</span><span class="p">])</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">detrender</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">6</span> <span class="k">else</span> <span class="mi">0</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">i1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i1_val</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">q1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">q1_val</span><span class="p">)</span>
        
        <span class="c1"># Advance the phase by 90 degrees</span>
        <span class="n">ji_val</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.0962</span><span class="o">*</span><span class="n">i1_val</span> <span class="o">+</span> <span class="mf">0.5769</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">i1</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> 
                 <span class="o">-</span> <span class="mf">0.5769</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">i1</span><span class="p">[</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.0962</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">i1</span><span class="p">[</span><span class="o">-</span><span class="mi">6</span><span class="p">])</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">i1</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">6</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="n">jq_val</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.0962</span><span class="o">*</span><span class="n">q1_val</span> <span class="o">+</span> <span class="mf">0.5769</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">q1</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> 
                 <span class="o">-</span> <span class="mf">0.5769</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">q1</span><span class="p">[</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.0962</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">q1</span><span class="p">[</span><span class="o">-</span><span class="mi">6</span><span class="p">])</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">q1</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">6</span> <span class="k">else</span> <span class="mi">0</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">ji</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ji_val</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">jq</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">jq_val</span><span class="p">)</span>
        
        <span class="c1"># Phasor addition</span>
        <span class="n">i2_val</span> <span class="o">=</span> <span class="n">i1_val</span> <span class="o">-</span> <span class="n">jq_val</span>
        <span class="n">q2_val</span> <span class="o">=</span> <span class="n">q1_val</span> <span class="o">+</span> <span class="n">ji_val</span>
        
        <span class="c1"># Smooth the I and Q components</span>
        <span class="n">i2_val</span> <span class="o">=</span> <span class="mf">0.2</span><span class="o">*</span><span class="n">i2_val</span> <span class="o">+</span> <span class="mf">0.8</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">i2</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">i2</span> <span class="k">else</span> <span class="n">i2_val</span>
        <span class="n">q2_val</span> <span class="o">=</span> <span class="mf">0.2</span><span class="o">*</span><span class="n">q2_val</span> <span class="o">+</span> <span class="mf">0.8</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">q2</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">q2</span> <span class="k">else</span> <span class="n">q2_val</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">i2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i2_val</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">q2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">q2_val</span><span class="p">)</span>
        
        <span class="c1"># Homodyne Discriminator</span>
        <span class="n">re_val</span> <span class="o">=</span> <span class="n">i2_val</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">i2</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">q2_val</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">q2</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">i2</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="n">im_val</span> <span class="o">=</span> <span class="n">i2_val</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">q2</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">q2_val</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">i2</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">i2</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="k">else</span> <span class="mi">0</span>
        
        <span class="n">re_val</span> <span class="o">=</span> <span class="mf">0.2</span><span class="o">*</span><span class="n">re_val</span> <span class="o">+</span> <span class="mf">0.8</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">re</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">re</span> <span class="k">else</span> <span class="n">re_val</span>
        <span class="n">im_val</span> <span class="o">=</span> <span class="mf">0.2</span><span class="o">*</span><span class="n">im_val</span> <span class="o">+</span> <span class="mf">0.8</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">im</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">im</span> <span class="k">else</span> <span class="n">im_val</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">re</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">re_val</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">im</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">im_val</span><span class="p">)</span>
        
        <span class="c1"># Compute the period</span>
        <span class="k">if</span> <span class="n">im_val</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">re_val</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">period_val</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan</span><span class="p">(</span><span class="n">im_val</span><span class="o">/</span><span class="n">re_val</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">period_val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">period</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">period</span> <span class="k">else</span> <span class="mi">15</span>
        
        <span class="k">if</span> <span class="n">period_val</span> <span class="o">&gt;</span> <span class="mf">1.5</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">period</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">period</span> <span class="k">else</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">period_val</span> <span class="o">=</span> <span class="mf">1.5</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">period</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">period_val</span> <span class="o">&lt;</span> <span class="mf">0.67</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">period</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">period</span> <span class="k">else</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">period_val</span> <span class="o">=</span> <span class="mf">0.67</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">period</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="n">period_val</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">:</span>
            <span class="n">period_val</span> <span class="o">=</span> <span class="mi">6</span>
        <span class="k">elif</span> <span class="n">period_val</span> <span class="o">&gt;</span> <span class="mi">50</span><span class="p">:</span>
            <span class="n">period_val</span> <span class="o">=</span> <span class="mi">50</span>
        
        <span class="n">period_val</span> <span class="o">=</span> <span class="mf">0.2</span><span class="o">*</span><span class="n">period_val</span> <span class="o">+</span> <span class="mf">0.8</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">period</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">period</span> <span class="k">else</span> <span class="n">period_val</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">period</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">period_val</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">smooth_period</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">0.33</span><span class="o">*</span><span class="n">period_val</span> <span class="o">+</span> <span class="mf">0.67</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">smooth_period</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">smooth_period</span> <span class="k">else</span> <span class="n">period_val</span><span class="p">)</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">dominant_cycle</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">smooth_period</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">smooth_period</span> <span class="k">else</span> <span class="kc">None</span>

<span class="k">class</span><span class="w"> </span><span class="nc">ChandeMomentumOscillator</span><span class="p">(</span><span class="n">BaseIndicator</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Chande Momentum Oscillator&quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_calculate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>
        
        <span class="n">gains</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">losses</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">period</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">change</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">change</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">gains</span> <span class="o">+=</span> <span class="n">change</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">losses</span> <span class="o">-=</span> <span class="n">change</span>
        
        <span class="k">if</span> <span class="n">gains</span> <span class="o">+</span> <span class="n">losses</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>
        
        <span class="k">return</span> <span class="mi">100</span> <span class="o">*</span> <span class="p">(</span><span class="n">gains</span> <span class="o">-</span> <span class="n">losses</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">gains</span> <span class="o">+</span> <span class="n">losses</span><span class="p">)</span>

<span class="k">class</span><span class="w"> </span><span class="nc">KnowSureThing</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Know Sure Thing (KST)&quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">roc1</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">roc2</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">15</span><span class="p">,</span> <span class="n">roc3</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span> <span class="n">roc4</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">30</span><span class="p">,</span>
                 <span class="n">sma1</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">sma2</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">sma3</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">sma4</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">15</span><span class="p">,</span> <span class="n">signal</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">9</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">roc1</span> <span class="o">=</span> <span class="n">ROC</span><span class="p">(</span><span class="n">roc1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">roc2</span> <span class="o">=</span> <span class="n">ROC</span><span class="p">(</span><span class="n">roc2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">roc3</span> <span class="o">=</span> <span class="n">ROC</span><span class="p">(</span><span class="n">roc3</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">roc4</span> <span class="o">=</span> <span class="n">ROC</span><span class="p">(</span><span class="n">roc4</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sma1</span> <span class="o">=</span> <span class="n">SMA</span><span class="p">(</span><span class="n">sma1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sma2</span> <span class="o">=</span> <span class="n">SMA</span><span class="p">(</span><span class="n">sma2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sma3</span> <span class="o">=</span> <span class="n">SMA</span><span class="p">(</span><span class="n">sma3</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sma4</span> <span class="o">=</span> <span class="n">SMA</span><span class="p">(</span><span class="n">sma4</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">signal_sma</span> <span class="o">=</span> <span class="n">SMA</span><span class="p">(</span><span class="n">signal</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kst_values</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">price</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">roc1</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">price</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">roc2</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">price</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">roc3</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">price</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">roc4</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">price</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">roc1</span><span class="o">.</span><span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sma1</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">roc1</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">roc2</span><span class="o">.</span><span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sma2</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">roc2</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">roc3</span><span class="o">.</span><span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sma3</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">roc3</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">roc4</span><span class="o">.</span><span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sma4</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">roc4</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">sma</span><span class="o">.</span><span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">sma</span> <span class="ow">in</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">sma1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sma2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sma3</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sma4</span><span class="p">]):</span>
            <span class="n">kst</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">sma1</span><span class="o">.</span><span class="n">value</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">sma2</span><span class="o">.</span><span class="n">value</span> <span class="o">+</span> <span class="mi">3</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">sma3</span><span class="o">.</span><span class="n">value</span> <span class="o">+</span> <span class="mi">4</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">sma4</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">kst_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">kst</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">signal_sma</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kst</span><span class="p">)</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">kst</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">kst_values</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">kst_values</span> <span class="k">else</span> <span class="kc">None</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">signal</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">signal_sma</span><span class="o">.</span><span class="n">value</span>

<span class="c1"># ============================================================================</span>
<span class="c1"># ADDITIONAL OSCILLATORS AND INDICATORS</span>
<span class="c1"># ============================================================================</span>

<span class="k">class</span><span class="w"> </span><span class="nc">PercentagePriceOscillator</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Percentage Price Oscillator (PPO)&quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fast_period</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">12</span><span class="p">,</span> <span class="n">slow_period</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">26</span><span class="p">,</span> <span class="n">signal_period</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">9</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fast_ema</span> <span class="o">=</span> <span class="n">EMA</span><span class="p">(</span><span class="n">fast_period</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slow_ema</span> <span class="o">=</span> <span class="n">EMA</span><span class="p">(</span><span class="n">slow_period</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">signal_ema</span> <span class="o">=</span> <span class="n">EMA</span><span class="p">(</span><span class="n">signal_period</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ppo_values</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">price</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fast_ema</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">price</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slow_ema</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">price</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fast_ema</span><span class="o">.</span><span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">slow_ema</span><span class="o">.</span><span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">slow_ema</span><span class="o">.</span><span class="n">value</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">ppo</span> <span class="o">=</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">fast_ema</span><span class="o">.</span><span class="n">value</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">slow_ema</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">slow_ema</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ppo_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ppo</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">signal_ema</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">ppo</span><span class="p">)</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">ppo</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ppo_values</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ppo_values</span> <span class="k">else</span> <span class="kc">None</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">signal</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">signal_ema</span><span class="o">.</span><span class="n">value</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">histogram</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ppo</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">signal</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ppo</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">signal</span>
        <span class="k">return</span> <span class="kc">None</span>

<span class="k">class</span><span class="w"> </span><span class="nc">DetrendedPriceOscillator</span><span class="p">(</span><span class="n">BaseIndicator</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Detrended Price Oscillator (DPO)&quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_calculate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">period</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>
        
        <span class="n">sma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">period</span><span class="p">:])</span>
        <span class="n">lookback_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">period</span> <span class="o">//</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span>
        
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">lookback_index</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="o">-</span><span class="n">lookback_index</span><span class="p">]</span> <span class="o">-</span> <span class="n">sma</span>
        <span class="k">return</span> <span class="mi">0</span>

<span class="k">class</span><span class="w"> </span><span class="nc">PriceOscillator</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Price Oscillator&quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fast_period</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">slow_period</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fast_sma</span> <span class="o">=</span> <span class="n">SMA</span><span class="p">(</span><span class="n">fast_period</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slow_sma</span> <span class="o">=</span> <span class="n">SMA</span><span class="p">(</span><span class="n">slow_period</span><span class="p">)</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">price</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fast_sma</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">price</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slow_sma</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">price</span><span class="p">)</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">value</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fast_sma</span><span class="o">.</span><span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">slow_sma</span><span class="o">.</span><span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">fast_sma</span><span class="o">.</span><span class="n">value</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">slow_sma</span><span class="o">.</span><span class="n">value</span>

<span class="k">class</span><span class="w"> </span><span class="nc">SchaffTrendCycle</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Schaff Trend Cycle&quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cycle_period</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">fast_period</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">23</span><span class="p">,</span> <span class="n">slow_period</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cycle_period</span> <span class="o">=</span> <span class="n">cycle_period</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fast_ema</span> <span class="o">=</span> <span class="n">EMA</span><span class="p">(</span><span class="n">fast_period</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slow_ema</span> <span class="o">=</span> <span class="n">EMA</span><span class="p">(</span><span class="n">slow_period</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">macd_values</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">k_values</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">d_values</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stc_values</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">price</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fast_ema</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">price</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slow_ema</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">price</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fast_ema</span><span class="o">.</span><span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">slow_ema</span><span class="o">.</span><span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">macd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fast_ema</span><span class="o">.</span><span class="n">value</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">slow_ema</span><span class="o">.</span><span class="n">value</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">macd_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">macd</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">macd_values</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cycle_period</span><span class="p">:</span>
                <span class="c1"># First stochastic calculation on MACD</span>
                <span class="n">macd_low</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">macd_values</span><span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">cycle_period</span><span class="p">:])</span>
                <span class="n">macd_high</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">macd_values</span><span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">cycle_period</span><span class="p">:])</span>
                
                <span class="k">if</span> <span class="n">macd_high</span> <span class="o">-</span> <span class="n">macd_low</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">k</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">*</span> <span class="p">(</span><span class="n">macd</span> <span class="o">-</span> <span class="n">macd_low</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">macd_high</span> <span class="o">-</span> <span class="n">macd_low</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">k</span> <span class="o">=</span> <span class="mi">50</span>
                
                <span class="bp">self</span><span class="o">.</span><span class="n">k_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k_values</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
                    <span class="n">d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k_values</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">:])</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">d_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
                    
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">d_values</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cycle_period</span><span class="p">:</span>
                        <span class="c1"># Second stochastic calculation on %D</span>
                        <span class="n">d_low</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">d_values</span><span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">cycle_period</span><span class="p">:])</span>
                        <span class="n">d_high</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">d_values</span><span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">cycle_period</span><span class="p">:])</span>
                        
                        <span class="k">if</span> <span class="n">d_high</span> <span class="o">-</span> <span class="n">d_low</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">stc</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">*</span> <span class="p">(</span><span class="n">d</span> <span class="o">-</span> <span class="n">d_low</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">d_high</span> <span class="o">-</span> <span class="n">d_low</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">stc</span> <span class="o">=</span> <span class="mi">50</span>
                        
                        <span class="bp">self</span><span class="o">.</span><span class="n">stc_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">stc</span><span class="p">)</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">value</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">stc_values</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stc_values</span> <span class="k">else</span> <span class="kc">None</span>

<span class="k">class</span><span class="w"> </span><span class="nc">ElderRayIndex</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Elder Ray Index (Bull Power and Bear Power)&quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">period</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">13</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ema</span> <span class="o">=</span> <span class="n">EMA</span><span class="p">(</span><span class="n">period</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bull_power</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bear_power</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">high</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">low</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">close</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ema</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">close</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ema</span><span class="o">.</span><span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">bull</span> <span class="o">=</span> <span class="n">high</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">ema</span><span class="o">.</span><span class="n">value</span>
            <span class="n">bear</span> <span class="o">=</span> <span class="n">low</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">ema</span><span class="o">.</span><span class="n">value</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">bull_power</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bull</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bear_power</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bear</span><span class="p">)</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">bull_power_value</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">bull_power</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bull_power</span> <span class="k">else</span> <span class="kc">None</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">bear_power_value</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">bear_power</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bear_power</span> <span class="k">else</span> <span class="kc">None</span>

<span class="k">class</span><span class="w"> </span><span class="nc">KaufmanEfficiencyRatio</span><span class="p">(</span><span class="n">BaseIndicator</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Kaufman Efficiency Ratio&quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_calculate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">period</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>
        
        <span class="n">direction</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">period</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">volatility</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> 
                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">period</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        
        <span class="k">return</span> <span class="n">direction</span> <span class="o">/</span> <span class="n">volatility</span> <span class="k">if</span> <span class="n">volatility</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>

<span class="k">class</span><span class="w"> </span><span class="nc">RelativeVigorIndex</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Relative Vigor Index&quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">period</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">period</span> <span class="o">=</span> <span class="n">period</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">closes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">opens</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">highs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lows</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rvi_values</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">signal_values</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">open_price</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">high</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">low</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">close</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">opens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">open_price</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">highs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">high</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">low</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">closes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">close</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">closes</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">period</span> <span class="o">*</span> <span class="mi">2</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">opens</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">opens</span><span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">period</span> <span class="o">*</span> <span class="mi">2</span><span class="p">:]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">highs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">highs</span><span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">period</span> <span class="o">*</span> <span class="mi">2</span><span class="p">:]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lows</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lows</span><span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">period</span> <span class="o">*</span> <span class="mi">2</span><span class="p">:]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">closes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">closes</span><span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">period</span> <span class="o">*</span> <span class="mi">2</span><span class="p">:]</span>
        
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">closes</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">period</span><span class="p">:</span>
            <span class="n">numerator</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">closes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">opens</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> 
                           <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">period</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
            <span class="n">denominator</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">highs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">lows</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> 
                             <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">period</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
            
            <span class="k">if</span> <span class="n">denominator</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">rvi</span> <span class="o">=</span> <span class="n">numerator</span> <span class="o">/</span> <span class="n">denominator</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">rvi_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rvi</span><span class="p">)</span>
                
                <span class="c1"># Signal line is 4-period SMA of RVI</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rvi_values</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">:</span>
                    <span class="n">signal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rvi_values</span><span class="p">[</span><span class="o">-</span><span class="mi">4</span><span class="p">:])</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">signal_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">signal</span><span class="p">)</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">rvi</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">rvi_values</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rvi_values</span> <span class="k">else</span> <span class="kc">None</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">signal</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">signal_values</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">signal_values</span> <span class="k">else</span> <span class="kc">None</span>

<span class="k">class</span><span class="w"> </span><span class="nc">MarketFacilitationIndex</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Market Facilitation Index&quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mfi_values</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">high</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">low</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">volume</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">volume</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">mfi</span> <span class="o">=</span> <span class="p">(</span><span class="n">high</span> <span class="o">-</span> <span class="n">low</span><span class="p">)</span> <span class="o">/</span> <span class="n">volume</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mfi</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">mfi_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mfi</span><span class="p">)</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">value</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mfi_values</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mfi_values</span> <span class="k">else</span> <span class="kc">None</span>

<span class="k">class</span><span class="w"> </span><span class="nc">IchimokuKinkoHyo</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Ichimoku Kinko Hyo&quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tenkan_period</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">9</span><span class="p">,</span> <span class="n">kijun_period</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">26</span><span class="p">,</span> 
                 <span class="n">senkou_b_period</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">52</span><span class="p">,</span> <span class="n">displacement</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">26</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tenkan_period</span> <span class="o">=</span> <span class="n">tenkan_period</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kijun_period</span> <span class="o">=</span> <span class="n">kijun_period</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">senkou_b_period</span> <span class="o">=</span> <span class="n">senkou_b_period</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">displacement</span> <span class="o">=</span> <span class="n">displacement</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">highs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lows</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">closes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tenkan_sen</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kijun_sen</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">senkou_span_a</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">senkou_span_b</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chikou_span</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">high</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">low</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">close</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">highs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">high</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">low</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">closes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">close</span><span class="p">)</span>
        
        <span class="c1"># Tenkan-sen (Conversion Line)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">highs</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tenkan_period</span><span class="p">:</span>
            <span class="n">tenkan_high</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">highs</span><span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">tenkan_period</span><span class="p">:])</span>
            <span class="n">tenkan_low</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lows</span><span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">tenkan_period</span><span class="p">:])</span>
            <span class="n">tenkan</span> <span class="o">=</span> <span class="p">(</span><span class="n">tenkan_high</span> <span class="o">+</span> <span class="n">tenkan_low</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tenkan_sen</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tenkan</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tenkan_sen</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
        
        <span class="c1"># Kijun-sen (Base Line)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">highs</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kijun_period</span><span class="p">:</span>
            <span class="n">kijun_high</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">highs</span><span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">kijun_period</span><span class="p">:])</span>
            <span class="n">kijun_low</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lows</span><span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">kijun_period</span><span class="p">:])</span>
            <span class="n">kijun</span> <span class="o">=</span> <span class="p">(</span><span class="n">kijun_high</span> <span class="o">+</span> <span class="n">kijun_low</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">kijun_sen</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">kijun</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">kijun_sen</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
        
        <span class="c1"># Senkou Span A (Leading Span A)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tenkan_sen</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kijun_sen</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tenkan_sen</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">kijun_sen</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">senkou_a</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tenkan_sen</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">kijun_sen</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">senkou_span_a</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">senkou_a</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">senkou_span_a</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">senkou_span_a</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
        
        <span class="c1"># Senkou Span B (Leading Span B)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">highs</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">senkou_b_period</span><span class="p">:</span>
            <span class="n">senkou_b_high</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">highs</span><span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">senkou_b_period</span><span class="p">:])</span>
            <span class="n">senkou_b_low</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lows</span><span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">senkou_b_period</span><span class="p">:])</span>
            <span class="n">senkou_b</span> <span class="o">=</span> <span class="p">(</span><span class="n">senkou_b_high</span> <span class="o">+</span> <span class="n">senkou_b_low</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">senkou_span_b</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">senkou_b</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">senkou_span_b</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
        
        <span class="c1"># Chikou Span (Lagging Span)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chikou_span</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">close</span><span class="p">)</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">tenkan</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tenkan_sen</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tenkan_sen</span> <span class="k">else</span> <span class="kc">None</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">kijun</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">kijun_sen</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">kijun_sen</span> <span class="k">else</span> <span class="kc">None</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">senkou_a</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">senkou_span_a</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">senkou_span_a</span> <span class="k">else</span> <span class="kc">None</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">senkou_b</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">senkou_span_b</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">senkou_span_b</span> <span class="k">else</span> <span class="kc">None</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">chikou</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">chikou_span</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">chikou_span</span> <span class="k">else</span> <span class="kc">None</span>

<span class="k">class</span><span class="w"> </span><span class="nc">PVT</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Price Volume Trend&quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pvt_value</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prev_close</span> <span class="o">=</span> <span class="kc">None</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">close</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">volume</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">prev_close</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">prev_close</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">pvt_change</span> <span class="o">=</span> <span class="n">volume</span> <span class="o">*</span> <span class="p">((</span><span class="n">close</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">prev_close</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">prev_close</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pvt_value</span> <span class="o">+=</span> <span class="n">pvt_change</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">prev_close</span> <span class="o">=</span> <span class="n">close</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">value</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pvt_value</span>

<span class="k">class</span><span class="w"> </span><span class="nc">TypicalPrice</span><span class="p">(</span><span class="n">BaseIndicator</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Typical Price (HLC/3)&quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">highs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lows</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">update_hlc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">high</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">low</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">close</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">highs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">high</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">low</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">close</span><span class="p">)</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_calculate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">highs</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">lows</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">highs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">lows</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mi">3</span>

<span class="k">class</span><span class="w"> </span><span class="nc">WeightedClose</span><span class="p">(</span><span class="n">BaseIndicator</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Weighted Close (HLCC/4)&quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">highs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lows</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">update_hlc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">high</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">low</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">close</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">highs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">high</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">low</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">close</span><span class="p">)</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_calculate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">highs</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">lows</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">highs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">lows</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mi">4</span>

<span class="k">class</span><span class="w"> </span><span class="nc">MedianPrice</span><span class="p">(</span><span class="n">BaseIndicator</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Median Price (HL/2)&quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">highs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lows</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">update_hl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">high</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">low</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">highs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">high</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">low</span><span class="p">)</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">value</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">highs</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">lows</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">highs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">lows</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span>

<span class="k">class</span><span class="w"> </span><span class="nc">AbsolutePriceOscillator</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Absolute Price Oscillator (APO)&quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fast_period</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">12</span><span class="p">,</span> <span class="n">slow_period</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">26</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fast_ema</span> <span class="o">=</span> <span class="n">EMA</span><span class="p">(</span><span class="n">fast_period</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slow_ema</span> <span class="o">=</span> <span class="n">EMA</span><span class="p">(</span><span class="n">slow_period</span><span class="p">)</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">price</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fast_ema</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">price</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slow_ema</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">price</span><span class="p">)</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">value</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fast_ema</span><span class="o">.</span><span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">slow_ema</span><span class="o">.</span><span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">fast_ema</span><span class="o">.</span><span class="n">value</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">slow_ema</span><span class="o">.</span><span class="n">value</span>

<span class="k">class</span><span class="w"> </span><span class="nc">BalanceOfPower</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Balance of Power&quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bop_values</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">open_price</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">high</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">low</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">close</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">high</span> <span class="o">!=</span> <span class="n">low</span><span class="p">:</span>
            <span class="n">bop</span> <span class="o">=</span> <span class="p">(</span><span class="n">close</span> <span class="o">-</span> <span class="n">open_price</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">high</span> <span class="o">-</span> <span class="n">low</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">bop</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">bop_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bop</span><span class="p">)</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">value</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">bop_values</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bop_values</span> <span class="k">else</span> <span class="kc">None</span>

<span class="k">class</span><span class="w"> </span><span class="nc">CooppockCurve</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Coppock Curve&quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wma_period</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">roc1_period</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">14</span><span class="p">,</span> <span class="n">roc2_period</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">11</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">roc1</span> <span class="o">=</span> <span class="n">ROC</span><span class="p">(</span><span class="n">roc1_period</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">roc2</span> <span class="o">=</span> <span class="n">ROC</span><span class="p">(</span><span class="n">roc2_period</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wma</span> <span class="o">=</span> <span class="n">WMA</span><span class="p">(</span><span class="n">wma_period</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">roc_sum_values</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">price</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">roc1</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">price</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">roc2</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">price</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">roc1</span><span class="o">.</span><span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">roc2</span><span class="o">.</span><span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">roc_sum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">roc1</span><span class="o">.</span><span class="n">value</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">roc2</span><span class="o">.</span><span class="n">value</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">roc_sum_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">roc_sum</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wma</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">roc_sum</span><span class="p">)</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">value</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">wma</span><span class="o">.</span><span class="n">value</span>

<span class="k">class</span><span class="w"> </span><span class="nc">RainbowOscillator</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Rainbow Oscillator&quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">period</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">period</span> <span class="o">=</span> <span class="n">period</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sma_levels</span> <span class="o">=</span> <span class="p">[</span><span class="n">SMA</span><span class="p">(</span><span class="n">period</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rb_values</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">price</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
        <span class="c1"># First level</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sma_levels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">price</span><span class="p">)</span>
        
        <span class="c1"># Subsequent levels</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sma_levels</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sma_levels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sma_levels</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        
        <span class="c1"># Calculate Rainbow Oscillator</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sma_levels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">sma_levels</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sma_levels</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">rb</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">*</span> <span class="p">(</span><span class="n">price</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">sma_levels</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">sma_levels</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">rb_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rb</span><span class="p">)</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">value</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">rb_values</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rb_values</span> <span class="k">else</span> <span class="kc">None</span>

<span class="k">class</span><span class="w"> </span><span class="nc">KeltnerBands</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Keltner Bands (alternative implementation)&quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">period</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span> <span class="n">multiplier</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.5</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ema</span> <span class="o">=</span> <span class="n">EMA</span><span class="p">(</span><span class="n">period</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sma_tr</span> <span class="o">=</span> <span class="n">SMA</span><span class="p">(</span><span class="n">period</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">multiplier</span> <span class="o">=</span> <span class="n">multiplier</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prev_close</span> <span class="o">=</span> <span class="kc">None</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">high</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">low</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">close</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ema</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">close</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">prev_close</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">tr</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">high</span> <span class="o">-</span> <span class="n">low</span><span class="p">,</span> <span class="nb">abs</span><span class="p">(</span><span class="n">high</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">prev_close</span><span class="p">),</span> <span class="nb">abs</span><span class="p">(</span><span class="n">low</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">prev_close</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sma_tr</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">tr</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">prev_close</span> <span class="o">=</span> <span class="n">close</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">middle</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ema</span><span class="o">.</span><span class="n">value</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">upper</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ema</span><span class="o">.</span><span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">sma_tr</span><span class="o">.</span><span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ema</span><span class="o">.</span><span class="n">value</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">multiplier</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">sma_tr</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">lower</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ema</span><span class="o">.</span><span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">sma_tr</span><span class="o">.</span><span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ema</span><span class="o">.</span><span class="n">value</span> <span class="o">-</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">multiplier</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">sma_tr</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>

<span class="k">class</span><span class="w"> </span><span class="nc">StochasticMomentumIndex</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Stochastic Momentum Index&quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k_period</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">d_period</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">k_period</span> <span class="o">=</span> <span class="n">k_period</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">d_period</span> <span class="o">=</span> <span class="n">d_period</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">highs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lows</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">closes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">smi_values</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">signal_sma</span> <span class="o">=</span> <span class="n">SMA</span><span class="p">(</span><span class="n">d_period</span><span class="p">)</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">high</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">low</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">close</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">highs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">high</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">low</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">closes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">close</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">closes</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_period</span> <span class="o">*</span> <span class="mi">2</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">highs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">highs</span><span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">k_period</span> <span class="o">*</span> <span class="mi">2</span><span class="p">:]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lows</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lows</span><span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">k_period</span> <span class="o">*</span> <span class="mi">2</span><span class="p">:]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">closes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">closes</span><span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">k_period</span> <span class="o">*</span> <span class="mi">2</span><span class="p">:]</span>
        
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">closes</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_period</span><span class="p">:</span>
            <span class="n">highest_high</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">highs</span><span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">k_period</span><span class="p">:])</span>
            <span class="n">lowest_low</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lows</span><span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">k_period</span><span class="p">:])</span>
            
            <span class="k">if</span> <span class="n">highest_high</span> <span class="o">!=</span> <span class="n">lowest_low</span><span class="p">:</span>
                <span class="n">hl_range</span> <span class="o">=</span> <span class="n">highest_high</span> <span class="o">-</span> <span class="n">lowest_low</span>
                <span class="n">close_position</span> <span class="o">=</span> <span class="n">close</span> <span class="o">-</span> <span class="p">(</span><span class="n">highest_high</span> <span class="o">+</span> <span class="n">lowest_low</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
                <span class="n">smi</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">*</span> <span class="p">(</span><span class="n">close_position</span> <span class="o">/</span> <span class="p">(</span><span class="n">hl_range</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">smi</span> <span class="o">=</span> <span class="mi">0</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">smi_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">smi</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">signal_sma</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">smi</span><span class="p">)</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">smi</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">smi_values</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">smi_values</span> <span class="k">else</span> <span class="kc">None</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">signal</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">signal_sma</span><span class="o">.</span><span class="n">value</span>

<span class="c1"># Indicators module</span>
<div class="viewcode-block" id="indicators">
<a class="viewcode-back" href="../../portfolio_lib.core.html#portfolio_lib.core.indicators">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">indicators</span><span class="p">:</span>
    <span class="c1"># Basic indicators (5)</span>
    <span class="n">SMA</span> <span class="o">=</span> <span class="n">SMA</span>
    <span class="n">EMA</span> <span class="o">=</span> <span class="n">EMA</span>
    <span class="n">RSI</span> <span class="o">=</span> <span class="n">RSI</span>
    <span class="n">MACD</span> <span class="o">=</span> <span class="n">MACD</span>
    <span class="n">BollingerBands</span> <span class="o">=</span> <span class="n">BollingerBands</span>
    
    <span class="c1"># Trend indicators (11)</span>
    <span class="n">WMA</span> <span class="o">=</span> <span class="n">WMA</span>
    <span class="n">DEMA</span> <span class="o">=</span> <span class="n">DEMA</span>
    <span class="n">TEMA</span> <span class="o">=</span> <span class="n">TEMA</span>
    <span class="n">KAMA</span> <span class="o">=</span> <span class="n">KAMA</span>
    <span class="n">HullMA</span> <span class="o">=</span> <span class="n">HullMA</span>
    <span class="n">VWAP</span> <span class="o">=</span> <span class="n">VWAP</span>
    <span class="n">ParabolicSAR</span> <span class="o">=</span> <span class="n">ParabolicSAR</span>
    <span class="n">McGinleyDynamic</span> <span class="o">=</span> <span class="n">McGinleyDynamic</span>
    <span class="n">VerticalHorizontalFilter</span> <span class="o">=</span> <span class="n">VerticalHorizontalFilter</span>
    <span class="n">SuperTrend</span> <span class="o">=</span> <span class="n">SuperTrend</span>
    <span class="n">AlmaIndicator</span> <span class="o">=</span> <span class="n">AlmaIndicator</span>
    
    <span class="c1"># Momentum indicators (25)</span>
    <span class="n">Stochastic</span> <span class="o">=</span> <span class="n">Stochastic</span>
    <span class="n">WilliamsR</span> <span class="o">=</span> <span class="n">WilliamsR</span>
    <span class="n">CCI</span> <span class="o">=</span> <span class="n">CCI</span>
    <span class="n">ROC</span> <span class="o">=</span> <span class="n">ROC</span>
    <span class="n">Momentum</span> <span class="o">=</span> <span class="n">Momentum</span>
    <span class="n">StochasticRSI</span> <span class="o">=</span> <span class="n">StochasticRSI</span>
    <span class="n">TRIX</span> <span class="o">=</span> <span class="n">TRIX</span>
    <span class="n">UltimateOscillator</span> <span class="o">=</span> <span class="n">UltimateOscillator</span>
    <span class="n">AwesomeOscillator</span> <span class="o">=</span> <span class="n">AwesomeOscillator</span>
    <span class="n">WavesTrend</span> <span class="o">=</span> <span class="n">WavesTrend</span>
    <span class="n">DeMarker</span> <span class="o">=</span> <span class="n">DeMarker</span>
    <span class="n">AroonIndicator</span> <span class="o">=</span> <span class="n">AroonIndicator</span>
    <span class="n">ChandeMomentumOscillator</span> <span class="o">=</span> <span class="n">ChandeMomentumOscillator</span>
    <span class="n">KnowSureThing</span> <span class="o">=</span> <span class="n">KnowSureThing</span>
    <span class="n">PercentagePriceOscillator</span> <span class="o">=</span> <span class="n">PercentagePriceOscillator</span>
    <span class="n">DetrendedPriceOscillator</span> <span class="o">=</span> <span class="n">DetrendedPriceOscillator</span>
    <span class="n">PriceOscillator</span> <span class="o">=</span> <span class="n">PriceOscillator</span>
    <span class="n">SchaffTrendCycle</span> <span class="o">=</span> <span class="n">SchaffTrendCycle</span>
    <span class="n">ElderRayIndex</span> <span class="o">=</span> <span class="n">ElderRayIndex</span>
    <span class="n">KaufmanEfficiencyRatio</span> <span class="o">=</span> <span class="n">KaufmanEfficiencyRatio</span>
    <span class="n">RelativeVigorIndex</span> <span class="o">=</span> <span class="n">RelativeVigorIndex</span>
    <span class="n">AbsolutePriceOscillator</span> <span class="o">=</span> <span class="n">AbsolutePriceOscillator</span>
    <span class="n">CooppockCurve</span> <span class="o">=</span> <span class="n">CooppockCurve</span>
    <span class="n">RainbowOscillator</span> <span class="o">=</span> <span class="n">RainbowOscillator</span>
    <span class="n">StochasticMomentumIndex</span> <span class="o">=</span> <span class="n">StochasticMomentumIndex</span>
    
    <span class="c1"># Volatility indicators (11)</span>
    <span class="n">ATR</span> <span class="o">=</span> <span class="n">ATR</span>
    <span class="n">TrueRange</span> <span class="o">=</span> <span class="n">TrueRange</span>
    <span class="n">KeltnerChannels</span> <span class="o">=</span> <span class="n">KeltnerChannels</span>
    <span class="n">DonchianChannels</span> <span class="o">=</span> <span class="n">DonchianChannels</span>
    <span class="n">ADX</span> <span class="o">=</span> <span class="n">ADX</span>
    <span class="n">StandardError</span> <span class="o">=</span> <span class="n">StandardError</span>
    <span class="n">MeanDeviation</span> <span class="o">=</span> <span class="n">MeanDeviation</span>
    <span class="n">ChoppinessIndex</span> <span class="o">=</span> <span class="n">ChoppinessIndex</span>
    <span class="n">RelativeVolatilityIndex</span> <span class="o">=</span> <span class="n">RelativeVolatilityIndex</span>
    <span class="n">KeltnerBands</span> <span class="o">=</span> <span class="n">KeltnerBands</span>
    
    <span class="c1"># Volume indicators (13)</span>
    <span class="n">OBV</span> <span class="o">=</span> <span class="n">OBV</span>
    <span class="n">AccumulationDistribution</span> <span class="o">=</span> <span class="n">AccumulationDistribution</span>
    <span class="n">ChaikinMoneyFlow</span> <span class="o">=</span> <span class="n">ChaikinMoneyFlow</span>
    <span class="n">VROC</span> <span class="o">=</span> <span class="n">VROC</span>
    <span class="n">ForceIndex</span> <span class="o">=</span> <span class="n">ForceIndex</span>
    <span class="n">VWMA</span> <span class="o">=</span> <span class="n">VWMA</span>
    <span class="n">MoneyFlowIndex</span> <span class="o">=</span> <span class="n">MoneyFlowIndex</span>
    <span class="n">VolumeOscillator</span> <span class="o">=</span> <span class="n">VolumeOscillator</span>
    <span class="n">EaseOfMovement</span> <span class="o">=</span> <span class="n">EaseOfMovement</span>
    <span class="n">NegativeVolumeIndex</span> <span class="o">=</span> <span class="n">NegativeVolumeIndex</span>
    <span class="n">PositiveVolumeIndex</span> <span class="o">=</span> <span class="n">PositiveVolumeIndex</span>
    <span class="n">MarketFacilitationIndex</span> <span class="o">=</span> <span class="n">MarketFacilitationIndex</span>
    <span class="n">PVT</span> <span class="o">=</span> <span class="n">PVT</span>
    
    <span class="c1"># Statistical indicators (5)</span>
    <span class="n">StandardDeviation</span> <span class="o">=</span> <span class="n">StandardDeviation</span>
    <span class="n">Variance</span> <span class="o">=</span> <span class="n">Variance</span>
    <span class="n">ZScore</span> <span class="o">=</span> <span class="n">ZScore</span>
    <span class="n">LinearRegression</span> <span class="o">=</span> <span class="n">LinearRegression</span>
    <span class="n">Correlation</span> <span class="o">=</span> <span class="n">Correlation</span>
    
    <span class="c1"># Pattern indicators (3)</span>
    <span class="n">PivotPoints</span> <span class="o">=</span> <span class="n">PivotPoints</span>
    <span class="n">FibonacciRetracement</span> <span class="o">=</span> <span class="n">FibonacciRetracement</span>
    <span class="n">ZigZag</span> <span class="o">=</span> <span class="n">ZigZag</span>
    
    <span class="c1"># Market Structure indicators (3)</span>
    <span class="n">SwingIndex</span> <span class="o">=</span> <span class="n">SwingIndex</span>
    <span class="n">AccumulativeSwingIndex</span> <span class="o">=</span> <span class="n">AccumulativeSwingIndex</span>
    <span class="n">FractalIndicator</span> <span class="o">=</span> <span class="n">FractalIndicator</span>
    
    <span class="c1"># Advanced Mathematical indicators (1)</span>
    <span class="n">HilbertTransform</span> <span class="o">=</span> <span class="n">HilbertTransform</span>
    
    <span class="c1"># Price indicators (4)</span>
    <span class="n">TypicalPrice</span> <span class="o">=</span> <span class="n">TypicalPrice</span>
    <span class="n">WeightedClose</span> <span class="o">=</span> <span class="n">WeightedClose</span>
    <span class="n">MedianPrice</span> <span class="o">=</span> <span class="n">MedianPrice</span>
    <span class="n">BalanceOfPower</span> <span class="o">=</span> <span class="n">BalanceOfPower</span>
    
    <span class="c1"># Complex indicators (1)</span>
    <span class="n">IchimokuKinkoHyo</span> <span class="o">=</span> <span class="n">IchimokuKinkoHyo</span></div>


<div class="viewcode-block" id="BaseStrategy">
<a class="viewcode-back" href="../../portfolio_lib.core.html#portfolio_lib.core.BaseStrategy">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">BaseStrategy</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Base strategy class&quot;&quot;&quot;</span>
<div class="viewcode-block" id="BaseStrategy.__init__">
<a class="viewcode-back" href="../../portfolio_lib.core.html#portfolio_lib.core.BaseStrategy.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_index</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">portfolio</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Portfolio</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">indicators</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">BaseIndicator</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span></div>

        
<div class="viewcode-block" id="BaseStrategy.init_indicators">
<a class="viewcode-back" href="../../portfolio_lib.core.html#portfolio_lib.core.BaseStrategy.init_indicators">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">init_indicators</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize technical indicators - to be implemented by subclasses&quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

    
<div class="viewcode-block" id="BaseStrategy.next">
<a class="viewcode-back" href="../../portfolio_lib.core.html#portfolio_lib.core.BaseStrategy.next">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">next</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Strategy logic for each bar - to be implemented by subclasses&quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>

    
<div class="viewcode-block" id="BaseStrategy.buy">
<a class="viewcode-back" href="../../portfolio_lib.core.html#portfolio_lib.core.BaseStrategy.buy">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">buy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">size</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">price</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Place a buy order&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">portfolio</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>
        
        <span class="n">current_price</span> <span class="o">=</span> <span class="n">price</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">current_index</span><span class="p">][</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span>
        <span class="n">current_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">current_index</span><span class="p">]</span>
        
        <span class="c1"># Calculate quantity based on size (as percentage of portfolio)</span>
        <span class="n">available_cash</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">portfolio</span><span class="o">.</span><span class="n">cash</span>
        <span class="n">order_value</span> <span class="o">=</span> <span class="n">available_cash</span> <span class="o">*</span> <span class="n">size</span>
        <span class="n">quantity</span> <span class="o">=</span> <span class="n">order_value</span> <span class="o">/</span> <span class="n">current_price</span>
        
        <span class="k">if</span> <span class="n">available_cash</span> <span class="o">&gt;=</span> <span class="n">order_value</span><span class="p">:</span>
            <span class="n">trade</span> <span class="o">=</span> <span class="n">Trade</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">quantity</span><span class="p">,</span> <span class="n">current_price</span><span class="p">,</span> <span class="n">current_time</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;BUY&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">portfolio</span><span class="o">.</span><span class="n">add_trade</span><span class="p">(</span><span class="n">trade</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="BaseStrategy.sell">
<a class="viewcode-back" href="../../portfolio_lib.core.html#portfolio_lib.core.BaseStrategy.sell">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">sell</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">size</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">price</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Place a sell order&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">portfolio</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">symbol</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">portfolio</span><span class="o">.</span><span class="n">positions</span><span class="p">:</span>
            <span class="k">return</span>
        
        <span class="n">current_price</span> <span class="o">=</span> <span class="n">price</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">current_index</span><span class="p">][</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span>
        <span class="n">current_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">current_index</span><span class="p">]</span>
        
        <span class="n">position</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">portfolio</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span>
        <span class="n">quantity</span> <span class="o">=</span> <span class="n">size</span> <span class="ow">or</span> <span class="n">position</span><span class="o">.</span><span class="n">quantity</span>
        
        <span class="n">trade</span> <span class="o">=</span> <span class="n">Trade</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">quantity</span><span class="p">,</span> <span class="n">current_price</span><span class="p">,</span> <span class="n">current_time</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;SELL&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">portfolio</span><span class="o">.</span><span class="n">add_trade</span><span class="p">(</span><span class="n">trade</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="BaseStrategy.position">
<a class="viewcode-back" href="../../portfolio_lib.core.html#portfolio_lib.core.BaseStrategy.position">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">position</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Position</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get current position for symbol&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">portfolio</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">portfolio</span><span class="o">.</span><span class="n">positions</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span></div>
</div>


<div class="viewcode-block" id="PerformanceMetrics">
<a class="viewcode-back" href="../../portfolio_lib.core.html#portfolio_lib.core.PerformanceMetrics">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">PerformanceMetrics</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculate performance metrics&quot;&quot;&quot;</span>
<div class="viewcode-block" id="PerformanceMetrics.__init__">
<a class="viewcode-back" href="../../portfolio_lib.core.html#portfolio_lib.core.PerformanceMetrics.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">equity_curve</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">timestamps</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">datetime</span><span class="p">],</span> <span class="n">trades</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Trade</span><span class="p">],</span> <span class="n">initial_cash</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">equity_curve</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">equity_curve</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timestamps</span> <span class="o">=</span> <span class="n">timestamps</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trades</span> <span class="o">=</span> <span class="n">trades</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initial_cash</span> <span class="o">=</span> <span class="n">initial_cash</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">returns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_returns</span><span class="p">()</span></div>

    
    <span class="k">def</span><span class="w"> </span><span class="nf">_calculate_returns</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate daily returns&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">equity_curve</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">equity_curve</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">equity_curve</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">total_return</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Total return percentage&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">equity_curve</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">0.0</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">equity_curve</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_cash</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_cash</span> <span class="o">*</span> <span class="mi">100</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">annualized_return</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Annualized return&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">equity_curve</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">0.0</span>
        
        <span class="n">days</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">timestamps</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">timestamps</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">days</span>
        <span class="k">if</span> <span class="n">days</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">0.0</span>
        
        <span class="n">years</span> <span class="o">=</span> <span class="n">days</span> <span class="o">/</span> <span class="mf">365.25</span>
        <span class="n">total_ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">equity_curve</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_cash</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">total_ret</span> <span class="o">**</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">years</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">volatility</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Annualized volatility&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">returns</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">0.0</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">returns</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">sharpe_ratio</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Sharpe ratio (assuming 0% risk-free rate)&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">returns</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">returns</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">0.0</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">returns</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">returns</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">max_drawdown</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Maximum drawdown percentage&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">equity_curve</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">0.0</span>
        
        <span class="n">peak</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="o">.</span><span class="n">accumulate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">equity_curve</span><span class="p">)</span>
        <span class="n">drawdown</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">equity_curve</span> <span class="o">-</span> <span class="n">peak</span><span class="p">)</span> <span class="o">/</span> <span class="n">peak</span> <span class="o">*</span> <span class="mi">100</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">drawdown</span><span class="p">)</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">sortino_ratio</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Sortino ratio&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">returns</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">0.0</span>
        
        <span class="n">negative_returns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">returns</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">returns</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">negative_returns</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>
        
        <span class="n">downside_deviation</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">negative_returns</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">downside_deviation</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">0.0</span>
        
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">returns</span><span class="p">)</span> <span class="o">/</span> <span class="n">downside_deviation</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">calmar_ratio</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calmar ratio&quot;&quot;&quot;</span>
        <span class="n">max_dd</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_drawdown</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">max_dd</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">0.0</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">annualized_return</span> <span class="o">/</span> <span class="n">max_dd</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">win_rate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Win rate percentage&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">trades</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">0.0</span>
        
        <span class="c1"># Group trades by symbol to calculate P&amp;L per round trip</span>
        <span class="n">positions</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">winning_trades</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">total_trades</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="k">for</span> <span class="n">trade</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">trades</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">trade</span><span class="o">.</span><span class="n">symbol</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">positions</span><span class="p">:</span>
                <span class="n">positions</span><span class="p">[</span><span class="n">trade</span><span class="o">.</span><span class="n">symbol</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            
            <span class="c1"># Check if it&#39;s a buy trade (handle both side and action attributes)</span>
            <span class="n">is_buy</span> <span class="o">=</span> <span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">trade</span><span class="p">,</span> <span class="s1">&#39;side&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">trade</span><span class="o">.</span><span class="n">side</span> <span class="o">==</span> <span class="s1">&#39;buy&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">trade</span><span class="p">,</span> <span class="s1">&#39;action&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">trade</span><span class="o">.</span><span class="n">action</span> <span class="o">==</span> <span class="s1">&#39;BUY&#39;</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">is_buy</span><span class="p">:</span>
                <span class="n">positions</span><span class="p">[</span><span class="n">trade</span><span class="o">.</span><span class="n">symbol</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">trade</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># sell</span>
                <span class="k">if</span> <span class="n">positions</span><span class="p">[</span><span class="n">trade</span><span class="o">.</span><span class="n">symbol</span><span class="p">]:</span>
                    <span class="n">buy_trade</span> <span class="o">=</span> <span class="n">positions</span><span class="p">[</span><span class="n">trade</span><span class="o">.</span><span class="n">symbol</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">pnl</span> <span class="o">=</span> <span class="p">(</span><span class="n">trade</span><span class="o">.</span><span class="n">price</span> <span class="o">-</span> <span class="n">buy_trade</span><span class="o">.</span><span class="n">price</span><span class="p">)</span> <span class="o">*</span> <span class="n">trade</span><span class="o">.</span><span class="n">quantity</span>
                    <span class="k">if</span> <span class="n">pnl</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">winning_trades</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">total_trades</span> <span class="o">+=</span> <span class="mi">1</span>
        
        <span class="k">return</span> <span class="p">(</span><span class="n">winning_trades</span> <span class="o">/</span> <span class="n">total_trades</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span> <span class="k">if</span> <span class="n">total_trades</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">0.0</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">profit_factor</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Profit factor&quot;&quot;&quot;</span>
        <span class="n">gross_profit</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">gross_loss</span> <span class="o">=</span> <span class="mf">0.0</span>
        
        <span class="n">positions</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">trade</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">trades</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">trade</span><span class="o">.</span><span class="n">symbol</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">positions</span><span class="p">:</span>
                <span class="n">positions</span><span class="p">[</span><span class="n">trade</span><span class="o">.</span><span class="n">symbol</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            
            <span class="c1"># Check if it&#39;s a buy trade (handle both side and action attributes)</span>
            <span class="n">is_buy</span> <span class="o">=</span> <span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">trade</span><span class="p">,</span> <span class="s1">&#39;side&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">trade</span><span class="o">.</span><span class="n">side</span> <span class="o">==</span> <span class="s1">&#39;buy&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">trade</span><span class="p">,</span> <span class="s1">&#39;action&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">trade</span><span class="o">.</span><span class="n">action</span> <span class="o">==</span> <span class="s1">&#39;BUY&#39;</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">is_buy</span><span class="p">:</span>
                <span class="n">positions</span><span class="p">[</span><span class="n">trade</span><span class="o">.</span><span class="n">symbol</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">trade</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># sell</span>
                <span class="k">if</span> <span class="n">positions</span><span class="p">[</span><span class="n">trade</span><span class="o">.</span><span class="n">symbol</span><span class="p">]:</span>
                    <span class="n">buy_trade</span> <span class="o">=</span> <span class="n">positions</span><span class="p">[</span><span class="n">trade</span><span class="o">.</span><span class="n">symbol</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">pnl</span> <span class="o">=</span> <span class="p">(</span><span class="n">trade</span><span class="o">.</span><span class="n">price</span> <span class="o">-</span> <span class="n">buy_trade</span><span class="o">.</span><span class="n">price</span><span class="p">)</span> <span class="o">*</span> <span class="n">trade</span><span class="o">.</span><span class="n">quantity</span>
                    <span class="k">if</span> <span class="n">pnl</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">gross_profit</span> <span class="o">+=</span> <span class="n">pnl</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">gross_loss</span> <span class="o">+=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">pnl</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">gross_profit</span> <span class="o">/</span> <span class="n">gross_loss</span> <span class="k">if</span> <span class="n">gross_loss</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">0.0</span></div>


<div class="viewcode-block" id="BacktestResults">
<a class="viewcode-back" href="../../portfolio_lib.core.html#portfolio_lib.core.BacktestResults">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">BacktestResults</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Backtest results container&quot;&quot;&quot;</span>
<div class="viewcode-block" id="BacktestResults.__init__">
<a class="viewcode-back" href="../../portfolio_lib.core.html#portfolio_lib.core.BacktestResults.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">portfolio</span><span class="p">:</span> <span class="n">Portfolio</span><span class="p">,</span> <span class="n">metrics</span><span class="p">:</span> <span class="n">PerformanceMetrics</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">portfolio</span> <span class="o">=</span> <span class="n">portfolio</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span> <span class="o">=</span> <span class="n">metrics</span></div>

    
<div class="viewcode-block" id="BacktestResults.summary">
<a class="viewcode-back" href="../../portfolio_lib.core.html#portfolio_lib.core.BacktestResults.summary">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">summary</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate summary report&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">BACKTEST RESULTS SUMMARY</span>
<span class="s2">=====================================</span>
<span class="s2">Initial Capital: $</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">portfolio</span><span class="o">.</span><span class="n">initial_cash</span><span class="si">:</span><span class="s2">,.2f</span><span class="si">}</span>
<span class="s2">Final Portfolio Value: $</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">portfolio</span><span class="o">.</span><span class="n">total_equity</span><span class="si">:</span><span class="s2">,.2f</span><span class="si">}</span>
<span class="s2">Total Return: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">total_return</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%</span>
<span class="s2">Annualized Return: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">annualized_return</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%</span>
<span class="s2">Max Drawdown: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">max_drawdown</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%</span>
<span class="s2">Sharpe Ratio: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">sharpe_ratio</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span>
<span class="s2">Sortino Ratio: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">sortino_ratio</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span>
<span class="s2">Calmar Ratio: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">calmar_ratio</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span>
<span class="s2">Volatility: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">volatility</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%</span>
<span class="s2">Win Rate: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">win_rate</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%</span>
<span class="s2">Profit Factor: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">profit_factor</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span>
<span class="s2">Total Trades: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">trades</span><span class="p">)</span><span class="si">}</span>
<span class="s2">&quot;&quot;&quot;</span></div>
</div>


<div class="viewcode-block" id="Backtest">
<a class="viewcode-back" href="../../portfolio_lib.core.html#portfolio_lib.core.Backtest">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Backtest</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Main backtesting engine&quot;&quot;&quot;</span>
<div class="viewcode-block" id="Backtest.__init__">
<a class="viewcode-back" href="../../portfolio_lib.core.html#portfolio_lib.core.Backtest.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">strategy</span><span class="p">:</span> <span class="n">BaseStrategy</span><span class="p">,</span> <span class="n">initial_cash</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">100000.0</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">strategy</span> <span class="o">=</span> <span class="n">strategy</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initial_cash</span> <span class="o">=</span> <span class="n">initial_cash</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_feed</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">DataFeed</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span></div>

        
<div class="viewcode-block" id="Backtest.add_data_source">
<a class="viewcode-back" href="../../portfolio_lib.core.html#portfolio_lib.core.Backtest.add_data_source">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">add_data_source</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_feed</span><span class="p">:</span> <span class="n">DataFeed</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add data source&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_feed</span> <span class="o">=</span> <span class="n">data_feed</span></div>

    
<div class="viewcode-block" id="Backtest.run">
<a class="viewcode-back" href="../../portfolio_lib.core.html#portfolio_lib.core.Backtest.run">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start_date</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;2020-01-01&#39;</span><span class="p">,</span> <span class="n">end_date</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">BacktestResults</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Run the backtest&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_feed</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No data feed configured&quot;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">end_date</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">end_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>
        
        <span class="c1"># Load data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_feed</span><span class="o">.</span><span class="n">load_data</span><span class="p">(</span><span class="n">start_date</span><span class="p">,</span> <span class="n">end_date</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">strategy</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_feed</span><span class="o">.</span><span class="n">data</span>
        
        <span class="c1"># Initialize portfolio</span>
        <span class="n">portfolio</span> <span class="o">=</span> <span class="n">Portfolio</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">initial_cash</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">strategy</span><span class="o">.</span><span class="n">portfolio</span> <span class="o">=</span> <span class="n">portfolio</span>
        
        <span class="c1"># Initialize strategy indicators</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">strategy</span><span class="o">.</span><span class="n">init_indicators</span><span class="p">()</span>
        
        <span class="c1"># Get the common date range across all symbols</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">strategy</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No data loaded&quot;</span><span class="p">)</span>
        
        <span class="c1"># Find common date range</span>
        <span class="n">date_ranges</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">strategy</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                <span class="n">date_ranges</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">date_ranges</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No valid data found&quot;</span><span class="p">)</span>
        
        <span class="n">start_common</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">start</span> <span class="k">for</span> <span class="n">start</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">date_ranges</span><span class="p">)</span>
        <span class="n">end_common</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">end</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">end</span> <span class="ow">in</span> <span class="n">date_ranges</span><span class="p">)</span>
        
        <span class="c1"># Align all data to common date range</span>
        <span class="n">aligned_data</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">strategy</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">aligned_data</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">start_common</span><span class="p">:</span><span class="n">end_common</span><span class="p">]</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">strategy</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">aligned_data</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">aligned_data</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No overlapping data found&quot;</span><span class="p">)</span>
        
        <span class="c1"># Get the primary symbol for iteration</span>
        <span class="n">primary_symbol</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">aligned_data</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">primary_data</span> <span class="o">=</span> <span class="n">aligned_data</span><span class="p">[</span><span class="n">primary_symbol</span><span class="p">]</span>
        
        <span class="c1"># Run backtest</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">primary_data</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">strategy</span><span class="o">.</span><span class="n">current_index</span> <span class="o">=</span> <span class="n">i</span>
            <span class="n">current_timestamp</span> <span class="o">=</span> <span class="n">primary_data</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            
            <span class="c1"># Update indicator values</span>
            <span class="n">current_prices</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">aligned_data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
                    <span class="n">current_price</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span>
                    <span class="n">current_prices</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span> <span class="o">=</span> <span class="n">current_price</span>
                    
                    <span class="c1"># Update indicators for this symbol</span>
                    <span class="k">if</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">strategy</span><span class="o">.</span><span class="n">indicators</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">indicator</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">strategy</span><span class="o">.</span><span class="n">indicators</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                            <span class="n">indicator</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">current_price</span><span class="p">)</span>
            
            <span class="c1"># Update portfolio prices</span>
            <span class="n">portfolio</span><span class="o">.</span><span class="n">update_prices</span><span class="p">(</span><span class="n">current_prices</span><span class="p">,</span> <span class="n">current_timestamp</span><span class="p">)</span>
            
            <span class="c1"># Execute strategy logic</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">strategy</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Strategy error at </span><span class="si">{</span><span class="n">current_timestamp</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="c1"># Calculate metrics</span>
        <span class="n">metrics</span> <span class="o">=</span> <span class="n">PerformanceMetrics</span><span class="p">(</span>
            <span class="n">portfolio</span><span class="o">.</span><span class="n">equity_curve</span><span class="p">,</span>
            <span class="n">portfolio</span><span class="o">.</span><span class="n">timestamps</span><span class="p">,</span>
            <span class="n">portfolio</span><span class="o">.</span><span class="n">trades</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">initial_cash</span>
        <span class="p">)</span>
        
        <span class="k">return</span> <span class="n">BacktestResults</span><span class="p">(</span><span class="n">portfolio</span><span class="p">,</span> <span class="n">metrics</span><span class="p">)</span></div>
</div>


<div class="viewcode-block" id="TechnicalIndicators">
<a class="viewcode-back" href="../../portfolio_lib.core.html#portfolio_lib.core.TechnicalIndicators">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">TechnicalIndicators</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Convenience class for technical indicator calculations&quot;&quot;&quot;</span>
    
<div class="viewcode-block" id="TechnicalIndicators.sma">
<a class="viewcode-back" href="../../portfolio_lib.core.html#portfolio_lib.core.TechnicalIndicators.sma">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">sma</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">period</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Simple Moving Average&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">data</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="n">period</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span></div>

    
<div class="viewcode-block" id="TechnicalIndicators.ema">
<a class="viewcode-back" href="../../portfolio_lib.core.html#portfolio_lib.core.TechnicalIndicators.ema">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">ema</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">period</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Exponential Moving Average&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">data</span><span class="o">.</span><span class="n">ewm</span><span class="p">(</span><span class="n">span</span><span class="o">=</span><span class="n">period</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span></div>

    
<div class="viewcode-block" id="TechnicalIndicators.rsi">
<a class="viewcode-back" href="../../portfolio_lib.core.html#portfolio_lib.core.TechnicalIndicators.rsi">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">rsi</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">period</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">14</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Relative Strength Index&quot;&quot;&quot;</span>
        <span class="n">delta</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span>
        <span class="n">gain</span> <span class="o">=</span> <span class="p">(</span><span class="n">delta</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">delta</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="n">period</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">delta</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">delta</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="n">period</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">rs</span> <span class="o">=</span> <span class="n">gain</span> <span class="o">/</span> <span class="n">loss</span>
        <span class="k">return</span> <span class="mi">100</span> <span class="o">-</span> <span class="p">(</span><span class="mi">100</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">rs</span><span class="p">))</span></div>

    
<div class="viewcode-block" id="TechnicalIndicators.bollinger_bands">
<a class="viewcode-back" href="../../portfolio_lib.core.html#portfolio_lib.core.TechnicalIndicators.bollinger_bands">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">bollinger_bands</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">period</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span> <span class="n">std_dev</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">2</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Bollinger Bands - returns (upper, middle, lower)&quot;&quot;&quot;</span>
        <span class="n">sma</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="n">period</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">std</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="n">period</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
        <span class="n">upper</span> <span class="o">=</span> <span class="n">sma</span> <span class="o">+</span> <span class="p">(</span><span class="n">std</span> <span class="o">*</span> <span class="n">std_dev</span><span class="p">)</span>
        <span class="n">lower</span> <span class="o">=</span> <span class="n">sma</span> <span class="o">-</span> <span class="p">(</span><span class="n">std</span> <span class="o">*</span> <span class="n">std_dev</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">upper</span><span class="p">,</span> <span class="n">sma</span><span class="p">,</span> <span class="n">lower</span></div>

    
<div class="viewcode-block" id="TechnicalIndicators.macd">
<a class="viewcode-back" href="../../portfolio_lib.core.html#portfolio_lib.core.TechnicalIndicators.macd">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">macd</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">fast</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">12</span><span class="p">,</span> <span class="n">slow</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">26</span><span class="p">,</span> <span class="n">signal</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">9</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;MACD - returns (macd_line, signal_line, histogram)&quot;&quot;&quot;</span>
        <span class="n">ema_fast</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">ewm</span><span class="p">(</span><span class="n">span</span><span class="o">=</span><span class="n">fast</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">ema_slow</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">ewm</span><span class="p">(</span><span class="n">span</span><span class="o">=</span><span class="n">slow</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">macd_line</span> <span class="o">=</span> <span class="n">ema_fast</span> <span class="o">-</span> <span class="n">ema_slow</span>
        <span class="n">signal_line</span> <span class="o">=</span> <span class="n">macd_line</span><span class="o">.</span><span class="n">ewm</span><span class="p">(</span><span class="n">span</span><span class="o">=</span><span class="n">signal</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">histogram</span> <span class="o">=</span> <span class="n">macd_line</span> <span class="o">-</span> <span class="n">signal_line</span>
        <span class="k">return</span> <span class="n">macd_line</span><span class="p">,</span> <span class="n">signal_line</span><span class="p">,</span> <span class="n">histogram</span></div>
</div>



<span class="c1"># Export main classes and functions</span>
<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;BaseStrategy&#39;</span><span class="p">,</span> <span class="s1">&#39;Backtest&#39;</span><span class="p">,</span> <span class="s1">&#39;YFinanceDataFeed&#39;</span><span class="p">,</span> <span class="s1">&#39;TechnicalIndicators&#39;</span><span class="p">,</span> <span class="s1">&#39;indicators&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Position&#39;</span><span class="p">,</span> <span class="s1">&#39;Trade&#39;</span><span class="p">,</span> <span class="s1">&#39;Portfolio&#39;</span><span class="p">,</span> <span class="s1">&#39;PerformanceMetrics&#39;</span><span class="p">,</span> <span class="s1">&#39;BacktestResults&#39;</span>
<span class="p">]</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Rahul Ashok, Pritham Devaprasad, Siddarth S, Anish R.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>